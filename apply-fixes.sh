#!/bin/bash

# üöÄ –ê–í–¢–û–ú–ê–¢–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ü–†–û–ë–õ–ï–ú
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤ –∞—É–¥–∏—Ç–µ

echo "üîç –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Reader Bot..."

# 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
cp .eslintrc.json .eslintrc.json.backup
cp package.json package.json.backup

# 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ESLint –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESLint –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if [ -f ".eslintrc.new.json" ]; then
    mv .eslintrc.new.json .eslintrc.json
    echo "‚úÖ ESLint –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
else
    echo "‚ùå –§–∞–π–ª .eslintrc.new.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ setup —Ñ–∞–π–ª–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤..."
if [ -f "tests/setup.js" ]; then
    echo "‚úÖ –§–∞–π–ª tests/setup.js –Ω–∞–π–¥–µ–Ω"
else
    echo "‚ùå –§–∞–π–ª tests/setup.js –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
    exit 1
fi

# 4. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
echo "üìö –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."
mkdir -p docs/{setup,architecture,development,features,troubleshooting}
mkdir -p archive/{work-logs,concepts,outdated}
echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–∞"

# 5. –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ Work Log —Ñ–∞–π–ª–æ–≤
echo "üìÇ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ Work Log —Ñ–∞–π–ª–æ–≤..."
mv WORK_LOG*.md archive/work-logs/ 2>/dev/null
echo "‚úÖ Work Log —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤"

# 6. –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üìÇ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
mv *–∫–æ–Ω—Ü–µ–ø—Ç*.txt archive/concepts/ 2>/dev/null
mv *–ø–ª–∞–Ω*.txt archive/concepts/ 2>/dev/null
echo "‚úÖ –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤"

# 7. –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ–∞–π–ª–æ–≤
echo "üìÇ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ–∞–π–ª–æ–≤..."
mv *_FIX*.md archive/outdated/ 2>/dev/null
mv *_FIXES*.md archive/outdated/ 2>/dev/null
mv CLEANUP*.md archive/outdated/ 2>/dev/null
mv STAGE*.md archive/outdated/ 2>/dev/null
mv CONTEXT_FIXES.md archive/outdated/ 2>/dev/null
mv CONSTRUCTOR_FIXES.md archive/outdated/ 2>/dev/null
mv ANALYTICS_FIXES.md archive/outdated/ 2>/dev/null
echo "‚úÖ –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤"

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
if [ ! -f ".env.example" ]; then
    echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç .env.example"
else
    echo "‚úÖ .env.example –Ω–∞–π–¥–µ–Ω"
fi

# 9. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∞—Ä—Ö–∏–≤–∞
echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .gitignore..."
if ! grep -q "archive/" .gitignore; then
    echo -e "\n# Archive directory\narchive/" >> .gitignore
    echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è archive/ –≤ .gitignore"
fi

# 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
echo "üìä –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
PROJECT_SIZE=$(du -sh . | cut -f1)
NODE_MODULES_SIZE=$(du -sh node_modules/ | cut -f1)
echo "üì¶ –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: $PROJECT_SIZE"
echo "üì¶ node_modules: $NODE_MODULES_SIZE"

# 11. –ü–æ–¥—Å—á–µ—Ç —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
JS_FILES=$(find . -name "*.js" -not -path "./node_modules/*" | wc -l)
MD_FILES=$(find . -name "*.md" -not -path "./node_modules/*" -not -path "./archive/*" | wc -l)
ARCHIVE_FILES=$(find archive/ -type f | wc -l)

echo "üìä –§–∞–π–ª—ã JavaScript: $JS_FILES"
echo "üìä –§–∞–π–ª—ã Markdown (–∞–∫—Ç–∏–≤–Ω—ã–µ): $MD_FILES" 
echo "üìä –§–∞–π–ª—ã –≤ –∞—Ä—Ö–∏–≤–µ: $ARCHIVE_FILES"

# 12. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if npm list @langchain/community 2>/dev/null | grep -q "WARN\|ERR"; then
    echo "‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ @langchain/community"
fi

if npm list pdfjs-dist 2>/dev/null | grep -q "WARN\|ERR"; then
    echo "‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ pdfjs-dist"
fi

if npm list xlsx 2>/dev/null | grep -q "xlsx"; then
    echo "‚ö†Ô∏è  –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–º–µ–Ω–∞ xlsx –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É"
fi

# 13. –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö
echo "üìÑ –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö..."
cat > FIXES_APPLIED.md << 'EOF'
# üöÄ –ü–†–ò–ú–ï–ù–Å–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

## –î–∞—Ç–∞: $(date)

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **ESLint –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º ESLint
   - –£–¥–∞–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ JSDoc –ø—Ä–∞–≤–∏–ª–∞
   - –î–æ–±–∞–≤–ª–µ–Ω—ã browser globals

2. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**
   - –°–æ–∑–¥–∞–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ docs/
   - –ü–µ—Ä–µ–º–µ—â–µ–Ω—ã Work Log —Ñ–∞–π–ª—ã –≤ archive/
   - –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –°–æ–∑–¥–∞–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π tests/setup.js
   - –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤

4. **–û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞**
   - –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ—Ä–Ω—è
   - –û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–∞ –∞—Ä—Ö–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
   - –û–±–Ω–æ–≤–ª–µ–Ω .gitignore

### üö® –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è:

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - –û–±–Ω–æ–≤–∏—Ç—å —É—è–∑–≤–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: @langchain/community, pdfjs-dist, xlsx
   - –ó–∞–º–µ–Ω–∏—Ç—å –¥–µ–º–æ-–ø–∞—Ä–æ–ª–∏ –≤ production

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**  
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (MongoDB connectivity)
   - –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

3. **–ö–æ–¥**
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å ~9000 ESLint –æ—à–∏–±–æ–∫
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
- JavaScript —Ñ–∞–π–ª–æ–≤: $(find . -name "*.js" -not -path "./node_modules/*" | wc -l)
- –ê–∫—Ç–∏–≤–Ω—ã—Ö MD —Ñ–∞–π–ª–æ–≤: $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./archive/*" | wc -l)
- –§–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ: $(find archive/ -type f 2>/dev/null | wc -l)
EOF

echo "‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: FIXES_APPLIED.md"

# 14. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
if [ -d "docs" ] && [ -d "archive" ] && [ -f "tests/setup.js" ]; then
    echo "üéâ –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
    echo ""
    echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
    echo "1. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: npm audit fix"
    echo "2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å ESLint –æ—à–∏–±–∫–∏: npm run lint:fix"
    echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã: npm test"
    echo "4. –û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª–∏ –≤ .env"
    echo ""
    echo "üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:"
    echo "- –ê—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞: PROJECT_AUDIT_REPORT.md"
    echo "- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: SECURITY_FIXES.md"
    echo "- –ü–ª–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: DOCS_REORGANIZATION_PLAN.md"
else
    echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    exit 1
fi