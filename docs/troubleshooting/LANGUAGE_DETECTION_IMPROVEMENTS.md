# Улучшенная система определения языка

## Обзор изменений

Мы значительно улучшили систему определения языка в Shrooms Support Bot для решения проблем с автоматическим определением языка при cURL запросах и обработке смешанного контента.

## Ключевые улучшения

### 1. Контекстное определение языка

- **Новый метод**: `detectLanguageWithContext()` 
- **Учитывает**: историю диалога, предпочтения пользователя, предыдущий язык разговора
- **Решает проблему**: Короткие сообщения теперь определяются правильно на основе контекста

### 2. Обработка смешанного контента

- **Разделяет** основной текст и технические вставки (JSON, URLs, коды ошибок)
- **Определяет язык** по основному содержимому, игнорируя техническую часть
- **Пример**: "У меня ошибка: Error: Connection failed" → русский (не английский)

### 3. Кеширование языковых предпочтений

- **Сохраняет** предпочтительный язык пользователя
- **Использует** для коротких сообщений и неопределенных случаев
- **Оптимизирован** с автоматической очисткой для экономии памяти

### 4. Улучшенная логика переключения языка

- **Быстрая проверка** явных признаков языка (кириллица, диакритики)
- **Умное определение** при переключении языка в диалоге
- **Сохранение контекста** при изменении языка

## Технические детали

### Новые методы в LanguageDetectService

```javascript
// Определение языка с контекстом
detectLanguageWithContext(text, options)

// Быстрая проверка очевидных случаев
quickLanguageCheck(text)

// Разделение технического контента
separateTechnicalContent(text)

// Анализ контекста диалога
analyzeConversationContext(history)

// Управление кешем
updateUserLanguagePreference(userId, language)
clearLanguageCache(userId)
```

### Обновления в ConversationService

```javascript
// Обновление языка разговора
updateLanguage(conversationId, language)
```

### Изменения в Chat API

- Используется `detectLanguageWithContext()` вместо простого `detectLanguage()`
- Передается история диалога и контекст пользователя
- Обновляется язык разговора при изменении
- Добавлен эндпоинт для очистки языкового кеша

## Примеры использования

### cURL без указания языка

```bash
# Теперь работает автоматически
curl -X POST http://localhost:3000/api/chat/message \
-H "Content-Type: application/json" \
-d '{"message": "Что такое токен SHROOMS?", "userId": "test-user"}'
```

### Смешанный контент

```bash
# Правильно определяется как русский
curl -X POST http://localhost:3000/api/chat/message \
-H "Content-Type: application/json" \
-d '{"message": "У меня ошибка: Error: Connection failed", "userId": "test-user"}'
```

### Короткие сообщения в диалоге

```bash
# Использует контекст предыдущих сообщений
curl -X POST http://localhost:3000/api/chat/message \
-H "Content-Type: application/json" \
-d '{"message": "Спасибо", "userId": "test-user", "conversationId": "existing-id"}'
```

## Результаты

### До улучшений:
- ❌ Смешанный контент определялся неправильно
- ❌ Короткие сообщения часто ошибались
- ❌ Требовалось явное указание языка в cURL
- ❌ Отсутствие контекста диалога

### После улучшений:
- ✅ Корректное определение основного языка
- ✅ Использование истории для коротких сообщений  
- ✅ Автоматическое определение без указания языка
- ✅ Умное переключение языка в диалоге
- ✅ Кеширование предпочтений пользователя

## Мониторинг и статистика

Получение статистики работы системы:

```bash
curl http://localhost:3000/api/chat/languages
```

Очистка кеша языка пользователя:

```bash
curl -X POST http://localhost:3000/api/chat/users/{userId}/clear-language-cache
```

## Бэкворд совместимость

Все изменения полностью совместимы с существующим API:
- Старый метод `detectLanguage()` сохранен
- Явное указание языка все еще работает
- Существующие эндпоинты не изменились

## Тестирование

Примеры тестов находятся в `examples/languageDetectionExamples.js`.

Запуск тестов:
```bash
# Простые тесты через cURL
npm run test:language

# Интеграционные тесты
npm run test:integration
```

## Производительность

- Кеш языковых предпочтений ограничен 10,000 пользователей
- Автоматическая очистка 10% самых старых записей при превышении лимита
- Минимальное влияние на время отклика API (< 5ms)

## Заключение

Улучшенная система определения языка решает основные проблемы UX и обеспечивает более надежную работу с многоязычным контентом, сохраняя при этом высокую производительность и совместимость.