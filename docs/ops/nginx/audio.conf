# Nginx Configuration for Audio Streaming

This configuration enables serving free audio files directly and protected audio files via X-Accel-Redirect.

## Configuration

Add the following to your Nginx configuration file (e.g., `/etc/nginx/sites-available/reader-bot`):

```nginx
# ==========================================
# AUDIO STREAMING CONFIGURATION
# ==========================================

# Free audio files - served directly
location /media/free/ {
    alias /srv/reader-audio/free/;
    
    # Enable range requests for seeking
    add_header Accept-Ranges bytes;
    
    # CORS headers for cross-origin playback
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods 'GET, HEAD, OPTIONS';
    add_header Access-Control-Allow-Headers 'Range';
    
    # Cache for 7 days
    expires 7d;
    add_header Cache-Control "public, immutable";
    
    # Compression
    gzip on;
    gzip_types audio/mpeg audio/mp3;
    
    # Security
    add_header X-Content-Type-Options nosniff;
}

# Protected audio files - internal only (served via X-Accel-Redirect)
location /media-protected/ {
    internal;
    alias /srv/reader-audio/;
    
    # Enable range requests for seeking
    add_header Accept-Ranges bytes;
    
    # CORS headers
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods 'GET, HEAD, OPTIONS';
    add_header Access-Control-Allow-Headers 'Range';
    
    # No cache for protected content
    add_header Cache-Control "private, no-cache";
    
    # Security
    add_header X-Content-Type-Options nosniff;
}

# Static assets (covers, etc.)
location /assets/audio/ {
    alias /srv/reader-audio/covers/;
    
    expires 30d;
    add_header Cache-Control "public, immutable";
    
    # CORS
    add_header Access-Control-Allow-Origin *;
}
```

## Directory Structure

Create the following directory structure on your VPS:

```bash
/srv/reader-audio/
├── free/              # Public free audio files
│   └── lpp.mp3       # Example: "Маленький принц"
├── protected/         # Protected premium audio files
│   └── premium-*.mp3
└── covers/           # Audio cover images
    └── free-lpp.jpg  # Example cover
```

## Setup Instructions

1. **Create directories:**
   ```bash
   sudo mkdir -p /srv/reader-audio/{free,protected,covers}
   sudo chown -R www-data:www-data /srv/reader-audio
   sudo chmod -R 755 /srv/reader-audio
   ```

2. **Upload audio files:**
   ```bash
   # Upload free audio
   sudo cp lpp.mp3 /srv/reader-audio/free/
   
   # Upload cover image
   sudo cp free-lpp.jpg /srv/reader-audio/covers/
   
   # Set permissions
   sudo chmod 644 /srv/reader-audio/free/*.mp3
   sudo chmod 644 /srv/reader-audio/covers/*.jpg
   ```

3. **Test the configuration:**
   ```bash
   # Test free audio access
   curl -I https://your-domain.com/media/free/lpp.mp3
   
   # Should return:
   # HTTP/1.1 200 OK
   # Accept-Ranges: bytes
   # Content-Type: audio/mpeg
   ```

4. **Reload Nginx:**
   ```bash
   sudo nginx -t
   sudo systemctl reload nginx
   ```

## Testing

### Test Free Audio

```bash
# Check if file is accessible
curl -I https://your-domain.com/media/free/lpp.mp3

# Test range request (for seeking)
curl -I -H "Range: bytes=0-1023" https://your-domain.com/media/free/lpp.mp3

# Download first 1MB for testing
curl -H "Range: bytes=0-1048575" https://your-domain.com/media/free/lpp.mp3 > test.mp3
```

### Test Protected Stream (via Backend)

```bash
# This should return 403 (internal only)
curl -I https://your-domain.com/media-protected/premium-1.mp3

# This should work (via backend authentication)
curl https://your-domain.com/api/reader/audio/premium-1/stream-url
```

## Security Notes

1. **Protected files** are only accessible via X-Accel-Redirect from Node.js backend
2. **Free files** are public but still benefit from range request support
3. CORS is enabled for audio playback from the mini-app
4. Content-Type headers are enforced to prevent MIME type confusion

## Performance Optimization

- Free audio files are cached for 7 days
- Protected files are not cached (user-specific access)
- Range requests enable efficient seeking without downloading entire file
- Gzip compression reduces bandwidth for metadata

## Troubleshooting

### Audio won't play

```bash
# Check Nginx error log
sudo tail -f /var/log/nginx/error.log

# Check file permissions
ls -la /srv/reader-audio/free/

# Test with curl
curl -v https://your-domain.com/media/free/lpp.mp3
```

### Range requests not working

```bash
# Verify Accept-Ranges header
curl -I https://your-domain.com/media/free/lpp.mp3 | grep Accept-Ranges

# Should show: Accept-Ranges: bytes
```

### CORS issues

```bash
# Check CORS headers
curl -I -H "Origin: https://web.telegram.org" \
  https://your-domain.com/media/free/lpp.mp3 | grep Access-Control
```

## X-Accel-Redirect Flow

For protected audio:

1. Client requests `/api/reader/audio/premium-1/stream-url`
2. Backend checks user entitlements
3. If authorized, backend returns X-Accel-Redirect header: `/media-protected/premium-1.mp3`
4. Nginx serves file from `/srv/reader-audio/premium-1.mp3`
5. File streamed directly to client (bypassing Node.js)

This provides both security (authentication) and performance (direct Nginx serving).
