/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 * –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±—ã—Å—Ç—Ä—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç–∏–∫–µ—Ç–æ–≤
 * @file server/services/diagnostics.js
 * üçÑ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç prompts-fixed.js
 */

const logger = require('../utils/logger');

/**
 * @typedef {Object} DiagnosticResult
 * @property {string} problemType - –¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã
 * @property {string[]} questions - –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
 * @property {string[]} solutions - –ë—ã—Å—Ç—Ä—ã–µ —Ä–µ—à–µ–Ω–∏—è
 * @property {boolean} needsTicket - –¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞
 * @property {string} response - –ì–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */

// üçÑ –ò–°–ü–†–ê–í–õ–ï–ù–û: Inline –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–º–µ—Å—Ç–æ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞ prompts-fixed.js
const DIAGNOSTIC_QUESTIONS = {
  wallet_connection: {
    en: [
      "What wallet are you trying to connect (Xverse, Hiro)?",
      "Do you see any error message?",
      "Is your wallet extension enabled?",
      "Do you have STX for transaction fees?"
    ],
    ru: [
      "–ö–∞–∫–æ–π –∫–æ—à–µ–ª–µ–∫ –≤—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å (Xverse, Hiro)?",
      "–í–∏–¥–∏—Ç–µ –ª–∏ –≤—ã —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ?",
      "–í–∫–ª—é—á–µ–Ω–æ –ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞?",
      "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å STX –¥–ª—è –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–π?"
    ],
    es: [
      "¬øQu√© billetera intentas conectar (Xverse, Hiro)?",
      "¬øVes alg√∫n mensaje de error?",
      "¬øEst√° habilitada la extensi√≥n de la billetera?",
      "¬øTienes STX para las tarifas de transacci√≥n?"
    ]
  },
  
  transaction_stuck: {
    en: [
      "How long has the transaction been pending?",
      "What is the transaction hash?",
      "What type of transaction were you making?",
      "Did you set custom gas fees?"
    ],
    ru: [
      "–ö–∞–∫ –¥–æ–ª–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–∂–∏–¥–∞–Ω–∏–∏?",
      "–ö–∞–∫–æ–π —Ö–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏?",
      "–ö–∞–∫–æ–π —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã –≤—ã–ø–æ–ª–Ω—è–ª–∏?",
      "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏ –ª–∏ –≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏?"
    ],
    es: [
      "¬øCu√°nto tiempo lleva pendiente la transacci√≥n?",
      "¬øCu√°l es el hash de la transacci√≥n?",
      "¬øQu√© tipo de transacci√≥n estabas haciendo?",
      "¬øEstableciste tarifas de gas personalizadas?"
    ]
  },
  
  tokens_missing: {
    en: [
      "What tokens are missing?",
      "When did you last see them?",
      "What was your last transaction?",
      "Are you looking at the correct wallet address?"
    ],
    ru: [
      "–ö–∞–∫–∏–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–æ–ø–∞–ª–∏?",
      "–ö–æ–≥–¥–∞ –≤—ã –∏—Ö –≤–∏–¥–µ–ª–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑?",
      "–ö–∞–∫–∞—è –±—ã–ª–∞ –≤–∞—à–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è?",
      "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç–µ –ª–∏ –≤—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞?"
    ],
    es: [
      "¬øQu√© tokens faltan?",
      "¬øCu√°ndo los viste por √∫ltima vez?",
      "¬øCu√°l fue tu √∫ltima transacci√≥n?",
      "¬øEst√°s mirando la direcci√≥n de billetera correcta?"
    ]
  },
  
  staking_issues: {
    en: [
      "What error do you see when staking?",
      "How much are you trying to stake?",
      "Which staking pool are you using?",
      "Do you have enough tokens for fees?"
    ],
    ru: [
      "–ö–∞–∫—É—é –æ—à–∏–±–∫—É –≤—ã –≤–∏–¥–∏—Ç–µ –ø—Ä–∏ —Å—Ç–µ–π–∫–∏–Ω–≥–µ?",
      "–°–∫–æ–ª—å–∫–æ –≤—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –∑–∞—Å—Ç–µ–π–∫–∞—Ç—å?",
      "–ö–∞–∫–æ–π –ø—É–ª —Å—Ç–µ–π–∫–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ?",
      "–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —É –≤–∞—Å —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–π?"
    ],
    es: [
      "¬øQu√© error ves al hacer staking?",
      "¬øCu√°nto intentas apostar?",
      "¬øQu√© pool de staking est√°s usando?",
      "¬øTienes suficientes tokens para las tarifas?"
    ]
  },
  
  farming_issues: {
    en: [
      "Which farming pool has the issue?",
      "Are you able to see your deposited tokens?",
      "When did you last harvest rewards?",
      "Do you see any error messages?"
    ],
    ru: [
      "–í –∫–∞–∫–æ–º –ø—É–ª–µ —Ñ–∞—Ä–º–∏–Ω–≥–∞ –ø—Ä–æ–±–ª–µ–º–∞?",
      "–í–∏–¥–∏—Ç–µ –ª–∏ –≤—ã –¥–µ–ø–æ–∑–∏—Ç–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã?",
      "–ö–æ–≥–¥–∞ –≤—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ —Å–æ–±–∏—Ä–∞–ª–∏ –Ω–∞–≥—Ä–∞–¥—ã?",
      "–í–∏–¥–∏—Ç–µ –ª–∏ –≤—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö?"
    ],
    es: [
      "¬øQu√© pool de farming tiene el problema?",
      "¬øPuedes ver tus tokens depositados?",
      "¬øCu√°ndo cosechaste recompensas por √∫ltima vez?",
      "¬øVes alg√∫n mensaje de error?"
    ]
  }
};

const QUICK_SOLUTIONS = {
  wallet_connection: {
    en: [
      "1. Refresh the page and try connecting again",
      "2. Make sure your wallet extension is unlocked",
      "3. Clear browser cache and cookies",
      "4. Try connecting in incognito mode",
      "5. Disable other wallet extensions temporarily",
      "6. Check if wallet has sufficient STX for fees"
    ],
    ru: [
      "1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞",
      "2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ",
      "3. –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –∏ –∫—É–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞",
      "4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ",
      "5. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ –¥—Ä—É–≥–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–æ–≤",
      "6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ STX –¥–ª—è –∫–æ–º–∏—Å—Å–∏–π"
    ],
    es: [
      "1. Actualiza la p√°gina e intenta conectar de nuevo",
      "2. Aseg√∫rate de que la extensi√≥n de la billetera est√© desbloqueada",
      "3. Limpia el cach√© y las cookies del navegador",
      "4. Intenta conectar en modo inc√≥gnito",
      "5. Desactiva temporalmente otras extensiones de billetera",
      "6. Verifica que tengas suficiente STX para las tarifas"
    ]
  },
  
  transaction_stuck: {
    en: [
      "1. Check transaction status on Stacks Explorer",
      "2. Wait for network congestion to clear (can take 30-60 minutes)",
      "3. Do not retry the same transaction multiple times",
      "4. Check if you have enough STX for fees",
      "5. Try increasing gas fees for future transactions"
    ],
    ru: [
      "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Stacks Explorer",
      "2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–æ–∫–∞ –ø—Ä–æ–π–¥–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–µ—Ç–∏ (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30-60 –º–∏–Ω—É—Ç)",
      "3. –ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç—É –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑",
      "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —É –≤–∞—Å STX –¥–ª—è –∫–æ–º–∏—Å—Å–∏–π",
      "5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–º–∏—Å—Å–∏–∏ –¥–ª—è –±—É–¥—É—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"
    ],
    es: [
      "1. Verifica el estado de la transacci√≥n en Stacks Explorer",
      "2. Espera a que se despeje la congesti√≥n de la red (puede tomar 30-60 minutos)",
      "3. No reintentes la misma transacci√≥n m√∫ltiples veces",
      "4. Verifica que tengas suficiente STX para las tarifas",
      "5. Intenta aumentar las tarifas de gas para futuras transacciones"
    ]
  },
  
  tokens_missing: {
    en: [
      "1. Check if you're viewing the correct wallet address",
      "2. Look for pending transactions that might not be confirmed",
      "3. Verify transaction history on Stacks Explorer",
      "4. Make sure you didn't send tokens to wrong address",
      "5. Check if tokens are staked or in farming pools"
    ],
    ru: [
      "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞",
      "2. –ü–æ–∏—â–∏—Ç–µ –æ–∂–∏–¥–∞—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã",
      "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ Stacks Explorer",
      "4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Ç–æ–∫–µ–Ω—ã –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å",
      "5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ª–∏ —Ç–æ–∫–µ–Ω—ã –≤ —Å—Ç–µ–π–∫–∏–Ω–≥–µ –∏–ª–∏ —Ñ–∞—Ä–º–∏–Ω–≥–µ"
    ],
    es: [
      "1. Verifica que est√©s viendo la direcci√≥n de billetera correcta",
      "2. Busca transacciones pendientes que podr√≠an no estar confirmadas",
      "3. Verifica el historial de transacciones en Stacks Explorer",
      "4. Aseg√∫rate de no haber enviado tokens a la direcci√≥n incorrecta",
      "5. Verifica si los tokens est√°n en staking o en pools de farming"
    ]
  },
  
  staking_issues: {
    en: [
      "1. Make sure you have minimum required amount for staking",
      "2. Check that you have enough STX for transaction fees",
      "3. Try refreshing the page and reconnecting wallet",
      "4. Verify that the staking pool is active",
      "5. Check if there are any maintenance periods"
    ],
    ru: [
      "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —Å—Ç–µ–π–∫–∏–Ω–≥–∞",
      "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —É –≤–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ STX –¥–ª—è –∫–æ–º–∏—Å—Å–∏–π",
      "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫",
      "4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—É–ª —Å—Ç–µ–π–∫–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–µ–Ω",
      "5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ—Ç –ª–∏ –ø–µ—Ä–∏–æ–¥–æ–≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è"
    ],
    es: [
      "1. Aseg√∫rate de tener la cantidad m√≠nima requerida para staking",
      "2. Verifica que tengas suficiente STX para las tarifas de transacci√≥n",
      "3. Intenta actualizar la p√°gina y reconectar la billetera",
      "4. Verifica que el pool de staking est√© activo",
      "5. Verifica si hay per√≠odos de mantenimiento"
    ]
  },
  
  farming_issues: {
    en: [
      "1. Check if the farming pool is still active",
      "2. Verify that you have liquidity tokens in the pool",
      "3. Try harvesting rewards to see if they appear",
      "4. Refresh the page and reconnect your wallet",
      "5. Check pool statistics for any changes"
    ],
    ru: [
      "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—É–ª —Ñ–∞—Ä–º–∏–Ω–≥–∞",
      "2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ç–æ–∫–µ–Ω—ã –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –≤ –ø—É–ª–µ",
      "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å, –ø–æ—è–≤—è—Ç—Å—è –ª–∏ –æ–Ω–∏",
      "4. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫",
      "5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—É–ª–∞ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
    ],
    es: [
      "1. Verifica si el pool de farming sigue activo",
      "2. Verifica que tengas tokens de liquidez en el pool",
      "3. Intenta cosechar recompensas para ver si aparecen",
      "4. Actualiza la p√°gina y reconecta tu billetera",
      "5. Verifica las estad√≠sticas del pool para cualquier cambio"
    ]
  }
};

/**
 * –ö–ª–∞—Å—Å –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 */
class DiagnosticsService {
  constructor() {
    // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ø—Ä–æ–±–ª–µ–º—ã
    this.problemPatterns = {
      wallet_connection: [
        /wallet.*connect/i,
        /connect.*wallet/i,
        /connection.*fail/i,
        /–º–æ–∂—Å[—Ç—á]–∞—Ç—å.*–∫–æ—à/i,
        /–ø–æ–¥–∫–ª—é—á.*–∫–æ—à/i,
        /conectar.*billetera/i,
        /cartera.*conectar/i
      ],
      
      transaction_stuck: [
        /transaction.*stuck/i,
        /tx.*pending/i,
        /—Ç—Ä–∞–Ω–∑–∞–∫—Ü.*–∑–∞–≤–µ—Ä—à/i,
        /—Ç—Ä–∞–Ω–∑–∞–∫—Ü.*–∑–∞—Å—Ç—Ä/i,
        /transacci√≥n.*pendiente/i,
        /transacci√≥n.*atascada/i
      ],
      
      tokens_missing: [
        /tokens.*disappear/i,
        /missing.*token/i,
        /tokens.*gone/i,
        /—Ç–æ–∫–µ–Ω.*–∏—Å—á–µ–∑/i,
        /—Ç–æ–∫–µ–Ω.*–ø—Ä–æ–ø–∞–ª/i,
        /tokens.*desapareci/i,
        /perdido.*token/i
      ],
      
      staking_issues: [
        /stak.*problem/i,
        /stak.*issue/i,
        /—Å—Ç–µ–π–∫.*–ø—Ä–æ–±–ª–µ–º/i,
        /—Å—Ç–µ–π–∫.*–æ—à–∏–±–∫/i,
        /problema.*staking/i,
        /error.*staking/i
      ],
      
      farming_issues: [
        /farm.*not.*work/i,
        /farming.*problem/i,
        /—Ñ–∞—Ä–º.*–Ω–µ.*—Ä–∞–±–æ—Ç/i,
        /—Ñ–∞—Ä–º.*–ø—Ä–æ–±–ª–µ–º/i,
        /farming.*problema/i,
        /problema.*farming/i
      ]
    };
    
    // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞
    this.ticketKeywords = [
      // English
      'urgent', 'help', 'error', 'bug', 'problem', 'issue', 'failed', 'broken',
      // Russian  
      '—Å—Ä–æ—á–Ω–æ', '–ø–æ–º–æ—â—å', '–æ—à–∏–±–∫–∞', '–±–∞–≥', '–ø—Ä–æ–±–ª–µ–º–∞', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', '—Å–ª–æ–º–∞–ª',
      // Spanish
      'urgente', 'ayuda', 'error', 'problema', 'bug', 'fallo', 'roto'
    ];
  }

  /**
   * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param {string} language - –Ø–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (en, ru, es)
   * @returns {DiagnosticResult} –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
   */
  async diagnose(message, language = 'en') {
    try {
      const problemType = this.identifyProblemType(message);
      const needsTicket = this.shouldCreateTicket(message, problemType);
      
      if (!problemType) {
        return {
          problemType: null,
          questions: [],
          solutions: [],
          needsTicket: needsTicket,
          response: this.generateGenericResponse(language, needsTicket)
        };
      }
      
      const questions = this.getQuestions(problemType, language);
      const solutions = this.getSolutions(problemType, language);
      const response = this.generateDiagnosticResponse(
        problemType, 
        questions, 
        solutions, 
        language, 
        needsTicket
      );
      
      logger.info(`Diagnosed problem: ${problemType}, needsTicket: ${needsTicket}`);
      
      return {
        problemType,
        questions,
        solutions,
        needsTicket,
        response
      };
    } catch (error) {
      logger.error(`Diagnostics error: ${error.message}`);
      return {
        problemType: null,
        questions: [],
        solutions: [],
        needsTicket: true,
        response: this.generateErrorResponse(language)
      };
    }
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {string|null} –¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ null
   */
  identifyProblemType(message) {
    for (const [problemType, patterns] of Object.entries(this.problemPatterns)) {
      if (patterns.some(pattern => pattern.test(message))) {
        return problemType;
      }
    }
    return null;
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∏–∫–µ—Ç
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
   * @param {string|null} problemType - –¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã
   * @returns {boolean} –ù—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∏–∫–µ—Ç
   */
  shouldCreateTicket(message, problemType) {
    // –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º —Ç–∏–∫–µ—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø—Ä–æ–±–ª–µ–º
    const alwaysTicketTypes = ['tokens_missing', 'transaction_stuck'];
    if (alwaysTicketTypes.includes(problemType)) {
      return true;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    const hasTicketKeywords = this.ticketKeywords.some(keyword =>
      message.toLowerCase().includes(keyword.toLowerCase())
    );
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å—ã, –¥–Ω–∏)
    const hasTimeReference = /(\d+\s*(hour|hours|—á–∞—Å|—á–∞—Å–∞|—á–∞—Å–æ–≤|hora|horas|day|days|–¥–µ–Ω—å|–¥–Ω—è|–¥–Ω–µ–π|d√≠a|d√≠as))/i.test(message);
    
    return hasTicketKeywords || hasTimeReference || problemType !== null;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ç–∏–ø–∞ –ø—Ä–æ–±–ª–µ–º—ã
   * @param {string} problemType - –¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã
   * @param {string} language - –Ø–∑—ã–∫
   * @returns {string[]} –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
   */
  getQuestions(problemType, language) {
    return DIAGNOSTIC_QUESTIONS[problemType]?.[language] || [];
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ç–∏–ø–∞ –ø—Ä–æ–±–ª–µ–º—ã
   * @param {string} problemType - –¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã  
   * @param {string} language - –Ø–∑—ã–∫
   * @returns {string[]} –°–ø–∏—Å–æ–∫ —Ä–µ—à–µ–Ω–∏–π
   */
  getSolutions(problemType, language) {
    return QUICK_SOLUTIONS[problemType]?.[language] || [];
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
   * @param {string} problemType - –¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã
   * @param {string[]} questions - –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
   * @param {string[]} solutions - –ë—ã—Å—Ç—Ä—ã–µ —Ä–µ—à–µ–Ω–∏—è
   * @param {string} language - –Ø–∑—ã–∫
   * @param {boolean} needsTicket - –ù—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∏–∫–µ—Ç
   * @returns {string} –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
   */
  generateDiagnosticResponse(problemType, questions, solutions, language, needsTicket) {
    const templates = {
      en: {
        greeting: "üçÑ I see you're having some trouble in our mycelial network! Let me help identify the issue.",
        solutions_intro: "Here are some quick solutions you can try:",
        questions_intro: "To better diagnose the problem, please tell me:",
        ticket_will_create: "I'll create a support ticket for our mushroom experts to investigate further.",
        ticket_not_needed: "Try these solutions first, and if the problem persists, I can create a support ticket for you."
      },
      ru: {
        greeting: "üçÑ –í–∏–∂—É, —á—Ç–æ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –≤ –Ω–∞—à–µ–π –≥—Ä–∏–±–Ω–æ–π —Å–µ—Ç–∏! –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π.",
        solutions_intro: "–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ—à–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:",
        questions_intro: "–î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –º–Ω–µ:",
        ticket_will_create: "–Ø —Å–æ–∑–¥–∞–º —Ç–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –Ω–∞—à–∏—Ö –≥—Ä–∏–±–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.",
        ticket_not_needed: "–°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —ç—Ç–∏ —Ä–µ—à–µ–Ω–∏—è, –∏ –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è, —è –º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏."
      },
      es: {
        greeting: "üçÑ ¬°Veo que tienes problemas en nuestra red micelial! D√©jame ayudarte a identificar el problema.",
        solutions_intro: "Aqu√≠ tienes algunas soluciones r√°pidas que puedes probar:",
        questions_intro: "Para diagnosticar mejor el problema, dime:",
        ticket_will_create: "Crear√© un ticket de soporte para que nuestros expertos hongos investiguen m√°s a fondo.",
        ticket_not_needed: "Prueba estas soluciones primero, y si el problema persiste, puedo crear un ticket de soporte para ti."
      }
    };

    const t = templates[language] || templates.en;
    let response = t.greeting + '\n\n';

    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—à–µ–Ω–∏—è
    if (solutions.length > 0) {
      response += t.solutions_intro + '\n';
      solutions.forEach((solution, index) => {
        response += `${index + 1}. ${solution}\n`;
      });
      response += '\n';
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    if (questions.length > 0 && !needsTicket) {
      response += t.questions_intro + '\n';
      questions.forEach((question, index) => {
        response += `‚Ä¢ ${question}\n`;
      });
      response += '\n';
    }

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–∫–µ—Ç–µ
    if (needsTicket) {
      response += t.ticket_will_create;
    } else {
      response += t.ticket_not_needed;
    }

    return response;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—â–∏–π –æ—Ç–≤–µ—Ç –∫–æ–≥–¥–∞ —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
   * @param {string} language - –Ø–∑—ã–∫
   * @param {boolean} needsTicket - –ù—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∏–∫–µ—Ç
   * @returns {string} –û—Ç–≤–µ—Ç
   */
  generateGenericResponse(language, needsTicket) {
    const templates = {
      en: needsTicket ? 
        "üçÑ I understand you're experiencing an issue. Let me create a support ticket for our mushroom experts to help you properly." :
        "üçÑ Hi there! I'm Sporus, your friendly mushroom assistant. How can I help you today?",
      ru: needsTicket ?
        "üçÑ –ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞. –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–º —Ç–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã –Ω–∞—à–∏ –≥—Ä–∏–±–Ω—ã–µ —ç–∫—Å–ø–µ—Ä—Ç—ã —Å–º–æ–≥–ª–∏ –ø–æ–º–æ—á—å –≤–∞–º –¥–æ–ª–∂–Ω—ã–º –æ–±—Ä–∞–∑–æ–º." :
        "üçÑ –ü—Ä–∏–≤–µ—Ç! –Ø Sporus, –≤–∞—à –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –≥—Ä–∏–±–Ω–æ–π –ø–æ–º–æ—â–Ω–∏–∫. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
      es: needsTicket ?
        "üçÑ Entiendo que tienes un problema. Perm√≠teme crear un ticket de soporte para que nuestros expertos hongos te ayuden adecuadamente." :
        "üçÑ ¬°Hola! Soy Sporus, tu amistoso asistente hongo. ¬øC√≥mo puedo ayudarte hoy?"
    };

    return templates[language] || templates.en;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
   * @param {string} language - –Ø–∑—ã–∫
   * @returns {string} –û—Ç–≤–µ—Ç
   */
  generateErrorResponse(language) {
    const templates = {
      en: "üçÑ I'm having trouble analyzing your message right now. Let me create a support ticket for our experts to assist you.",
      ru: "üçÑ –£ –º–µ–Ω—è –≤–æ–∑–Ω–∏–∫–ª–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–º —Ç–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –Ω–∞—à–∏—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤.",
      es: "üçÑ Tengo problemas para analizar tu mensaje ahora. Perm√≠teme crear un ticket de soporte para que nuestros expertos te ayuden."
    };

    return templates[language] || templates.en;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π
   * @param {string} problemType - –¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {boolean} –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π
   */
  isCriticalProblem(problemType, message) {
    const criticalPatterns = [
      /urgent/i,
      /critical/i,
      /—Å—Ä–æ—á–Ω–æ/i,
      /–∫—Ä–∏—Ç–∏—á–Ω–æ/i,
      /urgente/i,
      /cr√≠tico/i,
      /lost.*money/i,
      /–ø–æ—Ç–µ—Ä—è–ª.*–¥–µ–Ω—å–≥–∏/i,
      /perd√≠.*dinero/i
    ];

    return criticalPatterns.some(pattern => pattern.test(message)) ||
           ['tokens_missing', 'transaction_stuck'].includes(problemType);
  }
}

module.exports = new DiagnosticsService();