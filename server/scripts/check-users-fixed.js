/**
 * @fileoverview –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
 * @description –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–Ω–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–∑–¥–∞–Ω–Ω–æ–π —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
 */

const path = require('path');

// –ü–æ–¥–≥—Ä—É–∂–∞–µ–º .env –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
require('dotenv').config({ path: path.join(__dirname, '../../.env') });

const mongoose = require('mongoose');

// URI –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/reader_bot';

console.log('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏:');
console.log(`   MongoDB URI: ${MONGODB_URI}`);
console.log(`   –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${process.cwd()}`);
console.log(`   –ü—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É: ${__dirname}`);

async function checkUsers() {
  try {
    console.log('\nüîç –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB...');
    await mongoose.connect(MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true
    });
    console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');

    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –ø—É—Ç–µ–º
    const UserProfile = require(path.join(__dirname, '../models/userProfile.js'));
    const Quote = require(path.join(__dirname, '../models/quote.js'));
    
    console.log('‚úÖ –ú–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
    
    console.log('\nüìä –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const users = await UserProfile.find({}).sort({ registeredAt: -1 });
    
    console.log(`\nüë• –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}\n`);
    
    if (users.length === 0) {
      console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
      console.log('\nüîß –≠—Ç–æ –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å:');
      console.log('   1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞—è');
      console.log('   2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB');
      console.log('   3. –î–∞–Ω–Ω—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥—Ä—É–≥–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
      
      // –ü—Ä–æ–≤–µ—Ä–∏–º –≤—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
      console.log('\nüìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π...');
      const collections = await mongoose.connection.db.listCollections().toArray();
      console.log('–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:');
      collections.forEach(collection => {
        console.log(`   - ${collection.name}`);
      });
      
      return;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    users.forEach((user, index) => {
      console.log(`==================== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ${index + 1} ====================`);
      console.log(`üì± User ID: ${user.userId}`);
      console.log(`üë§ –ò–º—è: ${user.name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`);
      console.log(`üìß Email: ${user.email || '–Ω–µ —É–∫–∞–∑–∞–Ω'}`);
      console.log(`üîó Telegram: ${user.telegramUsername ? '@' + user.telegramUsername : '–Ω–µ —É–∫–∞–∑–∞–Ω'}`);
      console.log(`üìÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${user.registeredAt ? user.registeredAt.toLocaleString('ru-RU') : '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`);
      console.log(`‚úÖ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω: ${user.isOnboardingComplete ? '–î–∞' : '–ù–µ—Ç'}`);
      console.log(`üìç –ò—Å—Ç–æ—á–Ω–∏–∫: ${user.source || '–Ω–µ —É–∫–∞–∑–∞–Ω'}`);
      console.log(`üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞: ${user.botState?.currentState || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`);
      
      if (user.testResults && typeof user.testResults === 'object') {
        console.log(`üìù –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:`);
        Object.entries(user.testResults.toObject ? user.testResults.toObject() : user.testResults).forEach(([key, value]) => {
          if (value && key !== '_id' && key !== '__v') {
            console.log(`   ${key}: ${value}`);
          }
        });
      } else {
        console.log(`üìù –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞: –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã`);
      }
      
      if (user.statistics && typeof user.statistics === 'object') {
        console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:`);
        console.log(`   –í—Å–µ–≥–æ —Ü–∏—Ç–∞—Ç: ${user.statistics.totalQuotes || 0}`);
        console.log(`   –¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è: ${user.statistics.currentStreak || 0}`);
        console.log(`   –õ—É—á—à–∞—è —Å–µ—Ä–∏—è: ${user.statistics.longestStreak || 0}`);
        if (user.statistics.favoriteAuthors && user.statistics.favoriteAuthors.length > 0) {
          console.log(`   –õ—é–±–∏–º—ã–µ –∞–≤—Ç–æ—Ä—ã: ${user.statistics.favoriteAuthors.join(', ')}`);
        }
      } else {
        console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞`);
      }
      
      if (user.achievements && user.achievements.length > 0) {
        console.log(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: ${user.achievements.length}`);
        user.achievements.forEach(achievement => {
          console.log(`   - ${achievement.achievementId} (${achievement.unlockedAt.toLocaleDateString('ru-RU')})`);
        });
      }
      
      console.log(`‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: ${user.settings?.reminderEnabled ? '–≤–∫–ª—é—á–µ–Ω—ã' : '–≤—ã–∫–ª—é—á–µ–Ω—ã'}`);
      if (user.settings?.reminderTimes && user.settings.reminderTimes.length > 0) {
        console.log(`‚è∞ –í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: ${user.settings.reminderTimes.join(', ')}`);
      }
      
      console.log(`üíæ –°–æ–∑–¥–∞–Ω –≤ MongoDB: ${user.createdAt ? user.createdAt.toLocaleString('ru-RU') : '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`);
      console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω: ${user.updatedAt ? user.updatedAt.toLocaleString('ru-RU') : '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`);
      console.log(`üì± –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${user.lastActiveAt ? user.lastActiveAt.toLocaleString('ru-RU') : '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`);
      console.log('');
    });

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    console.log('==================== –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ====================');
    const completedOnboarding = users.filter(u => u.isOnboardingComplete).length;
    const withEmail = users.filter(u => u.email && u.email.trim() !== '').length;
    const withTelegram = users.filter(u => u.telegramUsername && u.telegramUsername.trim() !== '').length;
    const sources = users.reduce((acc, user) => {
      const source = user.source || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      acc[source] = (acc[source] || 0) + 1;
      return acc;
    }, {});

    console.log(`üìä –ó–∞–≤–µ—Ä—à–∏–ª–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥: ${completedOnboarding}/${users.length}`);
    console.log(`üìß –° —É–∫–∞–∑–∞–Ω–Ω—ã–º email: ${withEmail}/${users.length}`);
    console.log(`üì± –° Telegram username: ${withTelegram}/${users.length}`);
    console.log('\nüìç –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:');
    Object.entries(sources).forEach(([source, count]) => {
      console.log(`   ${source}: ${count}`);
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–∏—Ç–∞—Ç—ã
    console.log('\nüìñ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–∏—Ç–∞—Ç...');
    try {
      const totalQuotes = await Quote.countDocuments();
      const quotesPerUser = await Quote.aggregate([
        { $group: { _id: '$userId', count: { $sum: 1 } } },
        { $sort: { count: -1 } }
      ]);

      console.log(`üìö –í—Å–µ–≥–æ —Ü–∏—Ç–∞—Ç –≤ –±–∞–∑–µ: ${totalQuotes}`);
      
      if (quotesPerUser.length > 0) {
        console.log('üìä –¶–∏—Ç–∞—Ç –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:');
        quotesPerUser.forEach(item => {
          const user = users.find(u => u.userId === item._id);
          const userName = user ? (user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
          console.log(`   ${userName} (${item._id}): ${item.count} —Ü–∏—Ç–∞—Ç`);
        });
      } else {
        console.log('üìä –¶–∏—Ç–∞—Ç—ã –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ç–∞—Ç—ã
      if (totalQuotes > 0) {
        console.log('\nüìö –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ü–∏—Ç–∞—Ç:');
        const recentQuotes = await Quote.find({})
          .sort({ createdAt: -1 })
          .limit(5)
          .populate('userId', 'name');
          
        recentQuotes.forEach((quote, index) => {
          const userName = users.find(u => u.userId === quote.userId)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
          console.log(`   ${index + 1}. "${quote.text.substring(0, 50)}${quote.text.length > 50 ? '...' : ''}"`);
          console.log(`      –ê–≤—Ç–æ—Ä: ${quote.author || '–Ω–µ —É–∫–∞–∑–∞–Ω'}, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName}`);
          console.log(`      –î–∞—Ç–∞: ${quote.createdAt.toLocaleString('ru-RU')}`);
        });
      }
    } catch (quoteError) {
      console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ü–∏—Ç–∞—Ç:', quoteError.message);
    }

    // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ —Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
    console.log('\nü§ñ –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –ò–ó TELEGRAM –ë–û–¢–ê:');
    const telegramUsers = users.filter(u => 
      u.telegramUsername || 
      (u.testResults && Object.keys(u.testResults.toObject ? u.testResults.toObject() : u.testResults).some(key => key.startsWith('question'))) ||
      u.source !== 'test'
    );

    if (telegramUsers.length > 0) {
      console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${telegramUsers.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ Telegram –±–æ—Ç–∞:`);
      telegramUsers.forEach((user, index) => {
        console.log(`\n${index + 1}. ${user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'} (${user.userId})`);
        console.log(`   Telegram: ${user.telegramUsername ? '@' + user.telegramUsername : '–Ω–µ —É–∫–∞–∑–∞–Ω'}`);
        console.log(`   Email: ${user.email || '–Ω–µ —É–∫–∞–∑–∞–Ω'}`);
        console.log(`   –ò—Å—Ç–æ—á–Ω–∏–∫: ${user.source || '–Ω–µ —É–∫–∞–∑–∞–Ω'}`);
        console.log(`   –î–∞—Ç–∞: ${user.registeredAt ? user.registeredAt.toLocaleString('ru-RU') : '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`);
        console.log(`   –û–Ω–±–æ—Ä–¥–∏–Ω–≥: ${user.isOnboardingComplete ? '–∑–∞–≤–µ—Ä—à–µ–Ω' : '–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω'}`);
      });
    } else {
      console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ Telegram –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞
    console.log('\nü§ñ –°–û–°–¢–û–Ø–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –í –ë–û–¢–ï:');
    const botStates = users.reduce((acc, user) => {
      const state = user.botState?.currentState || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      acc[state] = (acc[state] || 0) + 1;
      return acc;
    }, {});

    Object.entries(botStates).forEach(([state, count]) => {
      console.log(`   ${state}: ${count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    console.log('\nüìà –ê–ö–¢–ò–í–ù–û–°–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô:');
    const now = new Date();
    const oneDay = 24 * 60 * 60 * 1000;
    const oneWeek = 7 * oneDay;
    const oneMonth = 30 * oneDay;

    const activeToday = users.filter(u => u.lastActiveAt && (now - u.lastActiveAt) < oneDay).length;
    const activeThisWeek = users.filter(u => u.lastActiveAt && (now - u.lastActiveAt) < oneWeek).length;
    const activeThisMonth = users.filter(u => u.lastActiveAt && (now - u.lastActiveAt) < oneMonth).length;

    console.log(`   –ê–∫—Ç–∏–≤–Ω—ã —Å–µ–≥–æ–¥–Ω—è: ${activeToday}`);
    console.log(`   –ê–∫—Ç–∏–≤–Ω—ã –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ: ${activeThisWeek}`);
    console.log(`   –ê–∫—Ç–∏–≤–Ω—ã –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ: ${activeThisMonth}`);

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error.message);
    console.error('Stack trace:', error.stack);
  } finally {
    await mongoose.disconnect();
    console.log('\nüîå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
  }
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏
if (require.main === module) {
  checkUsers().catch(console.error);
}

module.exports = { checkUsers };