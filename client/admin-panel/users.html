<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ß–∏—Ç–∞—Ç–µ–ª—å</title>
    <link rel="stylesheet" href="css/main.css">
    <meta name="description" content="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –ø—Ä–æ–µ–∫—Ç–∞ '–ß–∏—Ç–∞—Ç–µ–ª—å'">
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–æ–≤ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
    <script src="js/url-fix.js"></script>
</head>
<body>
    <!-- –ö–Ω–∏–∂–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–Ω–∞ -->
    <div class="reader-bg-animation reader-bg-subtle" id="reader-matrix"></div>
    
    <div class="admin-layout">
        <!-- Header -->
        <header class="admin-header">
            <div class="logo-container">
                <div class="logo-icon">üìñ</div>
                <h1>–ß–∏—Ç–∞—Ç–µ–ª—å</h1>
                <span class="logo-subtitle">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span>
            </div>
            
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">üìä –î–∞—à–±–æ—Ä–¥</a></li>
                    <li><a href="users.html" class="active">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
                    <li><a href="quotes.html">üìù –¶–∏—Ç–∞—Ç—ã</a></li>
                    <li><a href="reports.html">üìà –û—Ç—á–µ—Ç—ã</a></li>
                    <li><a href="tickets.html">üé´ –û–±—Ä–∞—â–µ–Ω–∏—è</a></li>
                    <li><a href="knowledge.html">üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</a></li>
                    <li><a href="prompts.html">üí≠ –ü—Ä–æ–º–ø—Ç—ã</a></li>
                </ul>
            </nav>
            
            <div class="user-menu">
                <span id="admin-username">–ê–Ω–Ω–∞ –ë—É—Å–µ–ª</span>
                <button id="logout-btn" class="btn btn-text">–í—ã—Ö–æ–¥</button>
            </div>
        </header>
        
        <!-- Main content -->
        <main class="admin-content">
            <div class="dashboard-header">
                <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn btn-primary" onclick="exportUsers()">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
                </div>
            </div>
            
            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="glow-card mb-4">
                <h3>üîç –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h3>
                <div class="filters-grid">
                    <div class="form-group">
                        <label for="search-users">–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email:</label>
                        <input type="text" id="search-users" class="form-control" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è –∏–ª–∏ email">
                    </div>
                    <div class="form-group">
                        <label for="filter-source">–ò—Å—Ç–æ—á–Ω–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</label>
                        <select id="filter-source" class="select-glow">
                            <option value="">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                            <option value="Instagram">Instagram</option>
                            <option value="Telegram">Telegram</option>
                            <option value="YouTube">YouTube</option>
                            <option value="Threads">Threads</option>
                            <option value="–î—Ä—É–∑—å—è">–û—Ç –¥—Ä—É–∑–µ–π</option>
                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-status">–°—Ç–∞—Ç—É—Å:</label>
                        <select id="filter-status" class="select-glow">
                            <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                            <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="completed_onboarding">–ó–∞–≤–µ—Ä—à–∏–ª–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-date">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</label>
                        <select id="filter-date" class="select-glow">
                            <option value="">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
                            <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats-cards">
                <div class="stat-card glow-card">
                    <div class="stat-header">
                        <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <div class="stat-icon">üë•</div>
                    </div>
                    <div class="stat-value" id="total-users">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="stat-change" id="total-users-change">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                
                <div class="stat-card glow-card">
                    <div class="stat-header">
                        <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                        <div class="stat-icon">üî•</div>
                    </div>
                    <div class="stat-value" id="active-users">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="stat-change" id="active-users-change">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                
                <div class="stat-card glow-card">
                    <div class="stat-header">
                        <h3>–ù–æ–≤—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
                        <div class="stat-icon">‚ú®</div>
                    </div>
                    <div class="stat-value" id="new-users">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="stat-change" id="new-users-change">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                
                <div class="stat-card glow-card">
                    <div class="stat-header">
                        <h3>Retention rate</h3>
                        <div class="stat-icon">üìà</div>
                    </div>
                    <div class="stat-value" id="retention-rate">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="stat-change" id="retention-change">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="glow-card">
                <div class="section-header">
                    <h3>üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="table-controls">
                        <span class="results-count">–ù–∞–π–¥–µ–Ω–æ: <span id="users-count">0</span> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è</th>
                                <th>Email</th>
                                <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                                <th>–¶–∏—Ç–∞—Ç</th>
                                <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr class="table-loading">
                                <td colspan="9">
                                    <div class="loading-spinner"></div>
                                    üìñ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                <div class="pagination" id="users-pagination">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JavaScript -->
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="admin-footer">
            <p>üìñ "–ß–∏—Ç–∞—Ç–µ–ª—å" - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</p>
            <p class="copyright">¬© 2025 –ê–Ω–Ω–∞ –ë—É—Å–µ–ª. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
        </footer>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="modal-overlay" id="user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ –î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="user-modal-content">
                <div class="loading-spinner"></div>
                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="modal-overlay" id="message-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="message-form">
                    <input type="hidden" id="message-user-id">
                    <div class="form-group">
                        <label for="message-text">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
                        <textarea id="message-text" class="form-control" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="message-type">–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
                        <select id="message-type" class="select-glow">
                            <option value="announcement">–û–±—ä—è–≤–ª–µ–Ω–∏–µ</option>
                            <option value="personal">–õ–∏—á–Ω–æ–µ</option>
                            <option value="reminder">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Notification system -->
    <div class="notification-container" id="notification-container"></div>
    
    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        /**
         * –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ API
         */
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentPage = 1;
        let currentFilters = {};
        let usersData = {};
        let isLoading = false;
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üë• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (typeof checkAuthStatus === 'function') {
                checkAuthStatus();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            initUsersPage();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
            if (typeof initReaderMatrix === 'function') {
                initReaderMatrix(true);
            }
        });
        
        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
         */
        async function initUsersPage() {
            try {
                await loadUsersStats();
                await loadUsersTable();
                setupFilters();
                setupMessageForm();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                showNotification('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }
        
        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
         */
        async function loadUsersStats() {
            try {
                console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                
                const response = await fetch('/api/users/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const stats = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                document.getElementById('total-users').textContent = formatNumber(stats.totalUsers);
                document.getElementById('active-users').textContent = formatNumber(stats.activeUsers);
                document.getElementById('new-users').textContent = formatNumber(stats.newUsersThisWeek);
                document.getElementById('retention-rate').textContent = `${stats.retentionRate}%`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                const changeElement = document.getElementById('new-users-change');
                if (stats.newUsersChange !== undefined) {
                    const changeClass = stats.newUsersChange >= 0 ? 'positive' : 'negative';
                    const changeSign = stats.newUsersChange >= 0 ? '+' : '';
                    changeElement.textContent = `${changeSign}${stats.newUsersChange}% –∑–∞ –Ω–µ–¥–µ–ª—é`;
                    changeElement.className = `stat-change ${changeClass}`;
                } else {
                    changeElement.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö';
                    changeElement.className = 'stat-change neutral';
                }
                
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–ø–æ–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω—ã–µ)
                document.getElementById('total-users-change').textContent = '–û–±—â–∏–π —Ä–æ—Å—Ç';
                document.getElementById('active-users-change').textContent = '–ó–∞ –Ω–µ–¥–µ–ª—é';
                document.getElementById('retention-change').textContent = '–ó–∞ –º–µ—Å—è—Ü';
                
                console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', stats);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ UI
                ['total-users', 'active-users', 'new-users', 'retention-rate'].forEach(id => {
                    document.getElementById(id).textContent = '‚Äî';
                });
                
                showNotification('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        }
        
        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
         */
        async function loadUsersTable(page = 1, filters = {}) {
            if (isLoading) return;
            
            try {
                isLoading = true;
                currentPage = page;
                currentFilters = { ...filters };
                
                console.log('üë• –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', { page, filters });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const tbody = document.getElementById('users-table-body');
                if (page === 1) {
                    tbody.innerHTML = `
                        <tr class="table-loading">
                            <td colspan="9">
                                <div class="loading-spinner"></div>
                                üìñ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
                            </td>
                        </tr>
                    `;
                }
                
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
                const params = new URLSearchParams({
                    page: page.toString(),
                    limit: '20',
                    ...filters
                });
                
                const response = await fetch(`/api/users?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                usersData = await response.json();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                displayUsers(usersData.users);
                displayPagination(usersData.pagination);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                document.getElementById('users-count').textContent = usersData.pagination.totalCount;
                
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', usersData);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = `
                    <tr class="table-error">
                        <td colspan="9">
                            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${error.message}
                            <button class="btn btn-sm" onclick="loadUsersTable()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                        </td>
                    </tr>
                `;
                
                showNotification('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                
            } finally {
                isLoading = false;
            }
        }
        
        /**
         * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ
         */
        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr class="table-empty">
                        <td colspan="9">
                            üìñ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const lastActivity = formatLastActivity(user.daysSinceLastActive, user.lastQuoteDate);
                const registrationDate = formatDate(user.registeredAt);
                const statusInfo = getUserStatusInfo(user);
                
                return `
                    <tr onclick="viewUser('${user.userId}')">
                        <td>
                            <span class="user-id">${user.userId.substring(0, 8)}...</span>
                        </td>
                        <td>
                            <div class="user-name">
                                <strong>${escapeHtml(user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏')}</strong>
                                ${user.telegramUsername ? `<small>@${user.telegramUsername}</small>` : ''}
                            </div>
                        </td>
                        <td>
                            <span class="user-email">${escapeHtml(user.email || '–ù–µ —É–∫–∞–∑–∞–Ω')}</span>
                        </td>
                        <td>
                            <span class="source-badge source-${(user.source || '–¥—Ä—É–≥–æ–µ').toLowerCase().replace(/[^a-z0-9]/g, '')}">${user.source || '–î—Ä—É–≥–æ–µ'}</span>
                        </td>
                        <td>
                            <span class="quotes-count">${user.quotesCount || 0}</span>
                        </td>
                        <td>
                            <span class="registration-date">${registrationDate}</span>
                            <small>${user.daysSinceRegistration} –¥–Ω–µ–π –Ω–∞–∑–∞–¥</small>
                        </td>
                        <td>
                            <span class="last-activity">${lastActivity}</span>
                        </td>
                        <td>
                            <span class="status-badge status-${statusInfo.class}">${statusInfo.text}</span>
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm" onclick="event.stopPropagation(); viewUser('${user.userId}')" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">üëÅÔ∏è</button>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); sendMessage('${user.userId}')" title="–ù–∞–ø–∏—Å–∞—Ç—å">üí¨</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        /**
         * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
         */
        function displayPagination(pagination) {
            const container = document.getElementById('users-pagination');
            
            if (pagination.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<div class="pagination-controls">';
            
            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
            if (pagination.hasPrevPage) {
                paginationHTML += `<button class="btn btn-pagination" onclick="changePage(${pagination.currentPage - 1})">‚Üê –ù–∞–∑–∞–¥</button>`;
            }
            
            // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
            const startPage = Math.max(1, pagination.currentPage - 2);
            const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button class="btn btn-pagination" onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += '<span class="pagination-dots">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === pagination.currentPage ? ' active' : '';
                paginationHTML += `<button class="btn btn-pagination${activeClass}" onclick="changePage(${i})">${i}</button>`;
            }
            
            if (endPage < pagination.totalPages) {
                if (endPage < pagination.totalPages - 1) {
                    paginationHTML += '<span class="pagination-dots">...</span>';
                }
                paginationHTML += `<button class="btn btn-pagination" onclick="changePage(${pagination.totalPages})">${pagination.totalPages}</button>`;
            }
            
            // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
            if (pagination.hasNextPage) {
                paginationHTML += `<button class="btn btn-pagination" onclick="changePage(${pagination.currentPage + 1})">–í–ø–µ—Ä–µ–¥ ‚Üí</button>`;
            }
            
            paginationHTML += '</div>';
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            paginationHTML += `
                <div class="pagination-info">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pagination.currentPage} –∏–∑ ${pagination.totalPages} 
                    (${pagination.totalCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
                </div>
            `;
            
            container.innerHTML = paginationHTML;
        }
        
        /**
         * –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
         */
        function changePage(page) {
            if (page !== currentPage && page >= 1) {
                loadUsersTable(page, currentFilters);
            }
        }
        
        /**
         * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
         */
        function setupFilters() {
            const searchInput = document.getElementById('search-users');
            const sourceFilter = document.getElementById('filter-source');
            const statusFilter = document.getElementById('filter-status');
            const dateFilter = document.getElementById('filter-date');
            
            // Debounced –ø–æ–∏—Å–∫
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 500);
            });
            
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
            [sourceFilter, statusFilter, dateFilter].forEach(element => {
                element.addEventListener('change', applyFilters);
            });
        }
        
        /**
         * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
         */
        function applyFilters() {
            const filters = {
                search: document.getElementById('search-users').value.trim(),
                source: document.getElementById('filter-source').value,
                status: document.getElementById('filter-status').value,
                dateFilter: document.getElementById('filter-date').value
            };
            
            // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            Object.keys(filters).forEach(key => {
                if (!filters[key]) {
                    delete filters[key];
                }
            });
            
            console.log('üîç –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', filters);
            loadUsersTable(1, filters);
        }
        
        /**
         * –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         */
        async function viewUser(userId) {
            try {
                console.log('üë§ –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('user-modal-content').innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        üìñ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...
                    </div>
                `;
                openModal('user-modal');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                const response = await fetch(`/api/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const userDetail = await response.json();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                displayUserDetail(userDetail);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                
                document.getElementById('user-modal-content').innerHTML = `
                    <div class="error-message">
                        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}
                        <button class="btn btn-secondary" onclick="viewUser('${userId}')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                `;
            }
        }
        
        /**
         * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
         */
        function displayUserDetail(user) {
            const modalContent = document.getElementById('user-modal-content');
            
            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞
            const testResults = user.testResults || {};
            const testResultsHTML = Object.keys(testResults).length > 0 ? `
                <div class="user-test-results">
                    <h5>üìù –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:</h5>
                    <ul>
                        ${Object.entries(testResults).map(([key, value]) => 
                            value ? `<li><strong>${getTestQuestionName(key)}:</strong> ${escapeHtml(value)}</li>` : ''
                        ).filter(Boolean).join('')}
                    </ul>
                </div>
            ` : '<div class="user-test-results"><p>–¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω</p></div>';
            
            // –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ç–∞—Ç—ã
            const recentQuotesHTML = user.quoteStats?.recent?.length > 0 ? `
                <div class="user-recent-quotes">
                    <h5>üìñ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ç–∞—Ç—ã:</h5>
                    <div class="quotes-list">
                        ${user.quoteStats.recent.slice(0, 5).map(quote => `
                            <div class="quote-item">
                                <div class="quote-text">"${escapeHtml(quote.text.substring(0, 100))}${quote.text.length > 100 ? '...' : ''}"</div>
                                <div class="quote-meta">
                                    ${quote.author ? `‚Äî ${escapeHtml(quote.author)}` : ''}
                                    <span class="quote-date">${formatDate(quote.createdAt)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '<div class="user-recent-quotes"><p>–¶–∏—Ç–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç</p></div>';
            
            // –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∞–≤—Ç–æ—Ä—ã
            const topCategoriesHTML = user.quoteStats?.topCategories?.length > 0 ? 
                user.quoteStats.topCategories.map(([cat, count]) => `${cat} (${count})`).join(', ') : 
                '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                
            const topAuthorsHTML = user.quoteStats?.topAuthors?.length > 0 ? 
                user.quoteStats.topAuthors.map(([author, count]) => `${author} (${count})`).join(', ') : 
                '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            
            modalContent.innerHTML = `
                <div class="user-details">
                    <div class="user-header">
                        <div class="user-avatar">üë§</div>
                        <div class="user-info">
                            <h4>${escapeHtml(user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏')}</h4>
                            <p>${escapeHtml(user.email || 'Email –Ω–µ —É–∫–∞–∑–∞–Ω')}</p>
                            ${user.telegramUsername ? `<p>@${escapeHtml(user.telegramUsername)}</p>` : ''}
                            <span class="status-badge status-${getUserStatusInfo(user).class}">${getUserStatusInfo(user).text}</span>
                        </div>
                    </div>
                    
                    <div class="user-stats">
                        <div class="stat-item">
                            <span class="stat-label">–¶–∏—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:</span>
                            <span class="stat-value">${user.quoteStats?.total || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">–î–Ω–µ–π —Å –±–æ—Ç–æ–º:</span>
                            <span class="stat-value">${user.daysSinceRegistration}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">–ò—Å—Ç–æ—á–Ω–∏–∫:</span>
                            <span class="stat-value">${user.source || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">–¶–∏—Ç–∞—Ç –≤ –¥–µ–Ω—å:</span>
                            <span class="stat-value">${user.engagement?.quotesPerDay || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è:</span>
                            <span class="stat-value">${user.statistics?.currentStreak || 0} –¥–Ω–µ–π</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">–õ—É—á—à–∞—è —Å–µ—Ä–∏—è:</span>
                            <span class="stat-value">${user.engagement?.longestStreak || 0} –¥–Ω–µ–π</span>
                        </div>
                    </div>
                    
                    ${testResultsHTML}
                    
                    <div class="user-preferences">
                        <h5>üéØ –ò–Ω—Ç–µ—Ä–µ—Å—ã –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</h5>
                        <p><strong>–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</strong> ${topCategoriesHTML}</p>
                        <p><strong>–õ—é–±–∏–º—ã–µ –∞–≤—Ç–æ—Ä—ã:</strong> ${topAuthorsHTML}</p>
                    </div>
                    
                    ${recentQuotesHTML}
                    
                    <div class="user-reports">
                        <h5>üìä –û—Ç—á–µ—Ç—ã:</h5>
                        <div class="reports-info">
                            <p><strong>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤:</strong> ${user.reports?.weekly?.length || 0}</p>
                            <p><strong>–ú–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤:</strong> ${user.reports?.monthly?.length || 0}</p>
                        </div>
                    </div>
                    
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="sendMessage('${user.userId}')">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                        <button class="btn btn-secondary" onclick="viewUserQuotes('${user.userId}')">üìù –í—Å–µ —Ü–∏—Ç–∞—Ç—ã</button>
                        <button class="btn btn-secondary" onclick="exportUserData('${user.userId}')">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                    </div>
                </div>
            `;
        }
        
        /**
         * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
         */
        function setupMessageForm() {
            const form = document.getElementById('message-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleSendMessage();
            });
        }
        
        /**
         * –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
         */
        async function sendMessage(userId) {
            console.log('üí¨ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:', userId);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('message-user-id').value = userId;
            document.getElementById('message-text').value = '';
            document.getElementById('message-type').value = 'announcement';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeModal(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ
            openModal('message-modal');
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                document.getElementById('message-text').focus();
            }, 100);
        }
        
        /**
         * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
         */
        async function handleSendMessage() {
            try {
                const userId = document.getElementById('message-user-id').value;
                const message = document.getElementById('message-text').value.trim();
                const messageType = document.getElementById('message-type').value;
                
                if (!message) {
                    showNotification('warning', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                    return;
                }
                
                console.log('üì® –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', { userId, messageType, message });
                
                const response = await fetch(`/api/users/${userId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    },
                    body: JSON.stringify({
                        message,
                        messageType
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', result);
                showNotification('success', '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');
                closeModal();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showNotification('error', `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`);
            }
        }
        
        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
         */
        async function refreshData() {
            console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            showNotification('info', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
            
            try {
                await Promise.all([
                    loadUsersStats(),
                    loadUsersTable(currentPage, currentFilters)
                ]);
                
                showNotification('success', '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('error', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
            }
        }
        
        /**
         * –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
         */
        async function exportUsers() {
            try {
                console.log('üì• –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                showNotification('info', '–ù–∞—á–∏–Ω–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                
                const response = await fetch('/api/users/export?format=json&includeQuotes=false', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reader-users-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification('success', '–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –§–∞–π–ª —Å–∫–∞—á–∞–Ω.');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                showNotification('error', `–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`);
            }
        }
        
        /**
         * –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         */
        async function exportUserData(userId) {
            try {
                const response = await fetch(`/api/users/export?format=json&includeQuotes=true&userId=${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reader-user-${userId}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification('success', '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                showNotification('error', '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }
        
        /**
         * –ü—Ä–æ—Å–º–æ—Ç—Ä —Ü–∏—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         */
        function viewUserQuotes(userId) {
            window.location.href = `quotes.html?userId=${userId}`;
        }
        
        // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        
        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞
         */
        function formatNumber(num) {
            if (num === null || num === undefined) return '‚Äî';
            return new Intl.NumberFormat('ru-RU').format(num);
        }
        
        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
         */
        function formatDate(dateString) {
            if (!dateString) return '‚Äî';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
         */
        function formatLastActivity(daysSinceLastActive, lastQuoteDate) {
            if (daysSinceLastActive === null || daysSinceLastActive === undefined) {
                return '–ù–µ –∞–∫—Ç–∏–≤–µ–Ω';
            }
            
            if (daysSinceLastActive === 0) {
                return '–°–µ–≥–æ–¥–Ω—è';
            } else if (daysSinceLastActive === 1) {
                return '–í—á–µ—Ä–∞';
            } else if (daysSinceLastActive <= 7) {
                return `${daysSinceLastActive} –¥–Ω. –Ω–∞–∑–∞–¥`;
            } else {
                return lastQuoteDate ? formatDate(lastQuoteDate) : '–î–∞–≤–Ω–æ';
            }
        }
        
        /**
         * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         */
        function getUserStatusInfo(user) {
            if (user.isBlocked) {
                return { class: 'blocked', text: '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' };
            }
            
            if (!user.isOnboardingComplete) {
                return { class: 'incomplete', text: '–ù–µ –∑–∞–≤–µ—Ä—à–∏–ª –æ–Ω–±–æ—Ä–¥–∏–Ω–≥' };
            }
            
            if (!user.isActive) {
                return { class: 'inactive', text: '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' };
            }
            
            switch (user.activityStatus) {
                case 'active':
                    return { class: 'active', text: '–ê–∫—Ç–∏–≤–µ–Ω' };
                case 'recent':
                    return { class: 'recent', text: '–ù–µ–¥–∞–≤–Ω–æ –∞–∫—Ç–∏–≤–µ–Ω' };
                default:
                    return { class: 'inactive', text: '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' };
            }
        }
        
        /**
         * –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞ —Ç–µ—Å—Ç–∞
         */
        function getTestQuestionName(key) {
            const questionNames = {
                'name': '–ò–º—è',
                'lifestyle': '–û —Å–µ–±–µ',
                'timeForSelf': '–í—Ä–µ–º—è –¥–ª—è —Å–µ–±—è',
                'priorities': '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã',
                'readingFeelings': '–ß—É–≤—Å—Ç–≤–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏',
                'closestPhrase': '–ë–ª–∏–∑–∫–∞—è —Ñ—Ä–∞–∑–∞',
                'readingTime': '–í—Ä–µ–º—è —á—Ç–µ–Ω–∏—è'
            };
            return questionNames[key] || key;
        }
        
        /**
         * –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        /**
         * Debounce —Ñ—É–Ω–∫—Ü–∏—è
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        /**
         * –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
         */
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        /**
         * –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
         */
        function closeModal() {
            const activeModal = document.querySelector('.modal-overlay.active');
            if (activeModal) {
                activeModal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-close') || e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
    
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .source-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .source-instagram { background: #e1306c; color: white; }
        .source-telegram { background: #0088cc; color: white; }
        .source-youtube { background: #ff0000; color: white; }
        .source-threads { background: #000000; color: white; }
        .source-–¥—Ä—É–∑—å—è, .source-friends { background: var(--reader-gold); color: var(--dark-bg); }
        .source-–¥—Ä—É–≥–æ–µ, .source-other { background: var(--text-muted); color: white; }
        
        .table-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .results-count {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .user-details {
            padding: 1rem;
        }
        
        .user-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .user-avatar {
            font-size: 3rem;
            background: var(--reader-gold);
            color: var(--dark-bg);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-white);
        }
        
        .user-info p {
            margin: 0 0 0.5rem 0;
            color: var(--text-muted);
        }
        
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .stat-label {
            display: block;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            display: block;
            color: var(--text-white);
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .user-test-results, .user-preferences, .user-recent-quotes, .user-reports {
            margin-bottom: 1.5rem;
        }
        
        .user-test-results h5, .user-preferences h5, .user-recent-quotes h5, .user-reports h5 {
            color: var(--reader-gold);
            margin-bottom: 1rem;
        }
        
        .user-test-results ul {
            list-style: none;
            padding: 0;
        }
        
        .user-test-results li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-light);
        }
        
        .user-test-results li:last-child {
            border-bottom: none;
        }
        
        .quotes-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .quote-item {
            background: var(--hover-bg);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .quote-text {
            color: var(--text-white);
            font-style: italic;
            margin-bottom: 0.5rem;
        }
        
        .quote-meta {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .quote-date {
            float: right;
        }
        
        .user-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .data-table tr {
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }
        
        .data-table tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }
        
        .table-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .user-id {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .user-name {
            display: flex;
            flex-direction: column;
        }
        
        .user-name small {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        .user-email {
            color: var(--text-light);
        }
        
        .quotes-count {
            font-weight: 600;
            color: var(--reader-gold);
        }
        
        .registration-date {
            display: block;
        }
        
        .registration-date + small {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        .last-activity {
            color: var(--text-light);
        }
        
        .pagination-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .btn-pagination {
            min-width: 40px;
            height: 40px;
        }
        
        .btn-pagination.active {
            background: var(--reader-gold);
            color: var(--dark-bg);
        }
        
        .pagination-dots {
            color: var(--text-muted);
            padding: 0 0.5rem;
        }
        
        .pagination-info {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .loading-container, .error-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--reader-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .table-loading, .table-error, .table-empty {
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        
        .reports-info p {
            margin: 0.5rem 0;
            color: var(--text-light);
        }
        
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .user-header {
                flex-direction: column;
                text-align: center;
            }
            
            .user-stats {
                grid-template-columns: 1fr;
            }
            
            .user-actions {
                flex-direction: column;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
            }
            
            .table-actions {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>
