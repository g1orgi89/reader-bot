<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shrooms Chat Widget Direct Integration Example</title>
  
  <style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body {
      font-family: 'Inter', 'Roboto', sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    
    h1, h2, h3 {
      color: #00b570;
    }
    
    .example-block {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    pre {
      background-color: #f0f0f0;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    
    code {
      font-family: monospace;
    }
    
    button {
      background-color: #00b570;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-weight: bold;
    }
    
    button:hover {
      background-color: #009960;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    
    .output {
      background-color: #1e1e1e;
      color: #e0e0e0;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      min-height: 100px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .output-title {
      color: #39FF14;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ —á–∞—Ç–∞ */
    .shrooms-widget-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      font-family: 'Inter', 'Roboto', 'Poppins', sans-serif;
    }
    
    .shrooms-widget {
      display: flex;
      flex-direction: column;
      max-width: 370px;
      width: 100%;
      box-shadow: 0 5px 40px rgba(0, 0, 0, 0.4);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .shrooms-widget.closed .shrooms-chat-window {
      display: none;
    }
    
    .shrooms-toggle-button {
      width: 60px;
      height: 60px;
      border-radius: 30px;
      background: #121212;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: absolute;
      bottom: 0;
      right: 0;
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.5);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .shrooms-toggle-button:hover {
      transform: scale(1.1);
      box-shadow: 0 0 30px rgba(57, 255, 20, 0.8);
    }
    
    .toggle-icon {
      width: 50px;
      height: 50px;
    }
    
    .shrooms-widget.open .shrooms-toggle-button {
      transform: scale(0);
      opacity: 0;
    }
    
    .shrooms-chat-window {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 500px;
      max-height: 80vh;
      background: #050505;
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .shrooms-chat-header {
      padding: 16px;
      background: #121212;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .shrooms-header-title {
      display: flex;
      align-items: center;
    }
    
    .shrooms-avatar {
      width: 32px;
      height: 32px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      margin-right: 10px;
    }
    
    .shrooms-title {
      font-weight: bold;
      font-size: 16px;
      color: #FFFFFF;
    }
    
    .shrooms-close-button {
      background: transparent;
      border: none;
      color: #E0E0E0;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .shrooms-close-button:hover {
      color: #39FF14;
    }
    
    .shrooms-chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .shrooms-messages-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .shrooms-message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .shrooms-message-user {
      align-self: flex-end;
      background: #8A2BE2;
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .shrooms-message-bot {
      align-self: flex-start;
      background: #121212;
      color: #E0E0E0;
      border-bottom-left-radius: 4px;
    }
    
    .shrooms-message-time {
      font-size: 10px;
      opacity: 0.7;
      position: absolute;
      bottom: -18px;
      right: 0;
    }
    
    .shrooms-chat-footer {
      padding: 16px;
      background: #121212;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .shrooms-input-container {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 24px;
      padding: 0 16px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    
    .shrooms-chat-input {
      flex: 1;
      background: transparent;
      border: none;
      padding: 12px 0;
      color: #E0E0E0;
      font-size: 14px;
    }
    
    .shrooms-chat-input:focus {
      outline: none;
    }
    
    .shrooms-chat-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .shrooms-send-button {
      background: transparent;
      border: none;
      color: #39FF14;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .shrooms-send-button:hover {
      color: #00FFF9;
      transform: scale(1.1);
    }
    
    .shrooms-branding {
      text-align: center;
      padding-top: 8px;
      font-size: 10px;
      opacity: 0.5;
      color: #E0E0E0;
    }
    
    .shrooms-typing-indicator {
      display: inline-block;
      position: relative;
      width: 50px;
      height: 20px;
    }
    
    .shrooms-typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #39FF14;
      position: absolute;
      bottom: 0;
      animation: typing 1.5s infinite ease-in-out;
    }
    
    .shrooms-typing-indicator span:nth-child(1) {
      left: 0;
      animation-delay: 0s;
    }
    
    .shrooms-typing-indicator span:nth-child(2) {
      left: 15px;
      animation-delay: 0.2s;
    }
    
    .shrooms-typing-indicator span:nth-child(3) {
      left: 30px;
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .shrooms-ticket-notification {
      background: #00FFF9;
      padding: 10px 16px;
      border-radius: 10px;
      margin: 10px 0;
      font-size: 12px;
      text-align: center;
      color: #000;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 255, 249, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(0, 255, 249, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 255, 249, 0); }
    }
  </style>
</head>
<body>
  <h1>Shrooms Chat Widget Direct Integration Example</h1>
  
  <div class="example-block">
    <h2>Widget Configuration</h2>
    <p>This example demonstrates how to integrate and control the Shrooms Chat Widget on your website using direct API integration (no iframe).</p>
    
    <pre><code>// Direct API initialization
const widget = new ShroomsDirectWidget({
  apiUrl: 'https://your-api-domain.com',
  theme: 'neon',
  autoOpen: false,
  onReady: () => console.log('Widget is ready!'),
  onMessage: (data) => console.log('New message:', data)
});</code></pre>
    
    <h3>Controls</h3>
    <div class="controls">
      <button id="btn-initialize">Initialize Widget</button>
      <button id="btn-open">Open Widget</button>
      <button id="btn-close">Close Widget</button>
      <button id="btn-send">Send Test Message</button>
      <button id="btn-clear">Clear History</button>
      
      <select id="language-select" title="Select Language">
        <option value="en">English</option>
        <option value="es">Spanish</option>
        <option value="ru">Russian</option>
      </select>
    </div>
    
    <div class="output">
      <div class="output-title">Event Log:</div>
      <div id="event-log"></div>
    </div>
  </div>
  
  <div class="example-block">
    <h2>Integration Guide</h2>
    <p>This example shows a direct API integration approach for the Shrooms widget:</p>
    
    <ul>
      <li>No iframe is used - direct communication with the API</li>
      <li>Better compatibility with different websites</li>
      <li>Customizable appearance and behavior</li>
      <li>Works well in environments where iframe may cause issues</li>
    </ul>
  </div>
  
  <!-- Chat Widget Container -->
  <div id="shrooms-widget-container" class="shrooms-widget-container">
    <div class="shrooms-widget closed" id="shrooms-widget">
      <div class="shrooms-toggle-button" id="shrooms-toggle">
        <div class="toggle-icon">
          <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –Ω–µ–æ–Ω–æ–≤—ã–π –ª–æ–≥–æ—Ç–∏–ø -->
          <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="neonGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#ffff00" />
                <stop offset="25%" stop-color="#39FF14" />
                <stop offset="50%" stop-color="#00FFF9" />
                <stop offset="75%" stop-color="#8A2BE2" />
                <stop offset="100%" stop-color="#FF6EC7" />
              </linearGradient>
              <filter id="glow">
                <feGaussianBlur stdDeviation="5" result="blur" />
                <feComposite in="SourceGraphic" in2="blur" operator="over" />
              </filter>
            </defs>
            <circle cx="256" cy="256" r="240" fill="none" stroke="url(#neonGradient)" stroke-width="15" filter="url(#glow)"/>
            <path fill="none" stroke="url(#neonGradient)" stroke-width="15" stroke-linecap="round" filter="url(#glow)" d="
              M 180 170
              Q 256 120 330 170
              Q 380 220 330 270
              L 300 270
              L 300 320
              Q 300 360 256 380
              Q 212 360 212 320
              L 212 270
              L 180 270
              Q 130 220 180 170
              Z"/>
            <circle cx="210" cy="200" r="10" fill="url(#neonGradient)" filter="url(#glow)"/>
            <circle cx="300" cy="200" r="10" fill="url(#neonGradient)" filter="url(#glow)"/>
            <rect x="245" y="160" width="20" height="20" transform="rotate(45 255 170)" fill="url(#neonGradient)" filter="url(#glow)"/>
            <ellipse cx="256" cy="330" rx="5" ry="10" fill="url(#neonGradient)" filter="url(#glow)"/>
            <ellipse cx="256" cy="360" rx="5" ry="10" fill="url(#neonGradient)" filter="url(#glow)"/>
          </svg>
        </div>
      </div>
      
      <div class="shrooms-chat-window">
        <div class="shrooms-chat-header">
          <div class="shrooms-header-title">
            <div class="shrooms-avatar">
              <!-- –ú–∞–ª–µ–Ω—å–∫–∏–π –ª–æ–≥–æ—Ç–∏–ø –¥–ª—è —Ö–µ–¥–µ—Ä–∞ -->
              <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="28" height="28">
                <defs>
                  <linearGradient id="headerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#ffff00" />
                    <stop offset="50%" stop-color="#39FF14" />
                    <stop offset="100%" stop-color="#00FFF9" />
                  </linearGradient>
                </defs>
                <circle cx="256" cy="256" r="240" fill="none" stroke="url(#headerGradient)" stroke-width="15"/>
                <path fill="none" stroke="url(#headerGradient)" stroke-width="15" stroke-linecap="round" d="
                  M 180 170
                  Q 256 120 330 170
                  Q 380 220 330 270
                  L 300 270
                  L 300 320
                  Q 300 360 256 380
                  Q 212 360 212 320
                  L 212 270
                  L 180 270
                  Q 130 220 180 170
                  Z"/>
                <circle cx="210" cy="200" r="10" fill="url(#headerGradient)"/>
                <circle cx="300" cy="200" r="10" fill="url(#headerGradient)"/>
                <rect x="245" y="160" width="20" height="20" transform="rotate(45 255 170)" fill="url(#headerGradient)"/>
                <ellipse cx="256" cy="330" rx="5" ry="10" fill="url(#headerGradient)"/>
                <ellipse cx="256" cy="360" rx="5" ry="10" fill="url(#headerGradient)"/>
              </svg>
            </div>
            <div class="shrooms-title">Shrooms Support</div>
          </div>
          <div class="shrooms-header-actions">
            <button class="shrooms-close-button" id="shrooms-close">√ó</button>
          </div>
        </div>
        
        <div class="shrooms-chat-body">
          <div class="shrooms-messages-container" id="shrooms-messages"></div>
        </div>
        
        <div class="shrooms-chat-footer">
          <div class="shrooms-input-container">
            <input 
              type="text" 
              class="shrooms-chat-input" 
              id="shrooms-input"
              placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
            />
            <button class="shrooms-send-button" id="shrooms-send">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <div class="shrooms-branding">Powered by Shrooms</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –≤–∏–¥–∂–µ—Ç–∞ —Å –ø—Ä—è–º–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
    class ShroomsDirectWidget {
      constructor(config) {
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        this.config = {
          apiUrl: config.apiUrl || 'http://localhost:3000',
          theme: config.theme || 'neon',
          position: config.position || { side: 'right', align: 'bottom', offset: '20px' },
          autoOpen: config.autoOpen || false,
          welcomeMessage: config.welcomeMessage || '–ü—Ä–∏–≤–µ—Ç! –Ø - –≥—Ä–∏–±–Ω–æ–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?',
          onReady: config.onReady || (() => {}),
          onMessage: config.onMessage || (() => {}),
          onOpen: config.onOpen || (() => {}),
          onClose: config.onClose || (() => {}),
          onError: config.onError || (() => {}),
          onTicketCreated: config.onTicketCreated || (() => {})
        };
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞
        this.state = {
          isOpen: false,
          isLoading: false,
          isInitialized: false,
          messages: [],
          userId: this._getUserId(),
          language: navigator.language.split('-')[0] || 'en',
          conversationId: null
        };
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        this.elements = {
          container: document.getElementById('shrooms-widget-container'),
          widget: document.getElementById('shrooms-widget'),
          toggle: document.getElementById('shrooms-toggle'),
          close: document.getElementById('shrooms-close'),
          messages: document.getElementById('shrooms-messages'),
          input: document.getElementById('shrooms-input'),
          send: document.getElementById('shrooms-send')
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        this._bindEvents();
        
        // –ï—Å–ª–∏ autoOpen, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç
        if (this.config.autoOpen) {
          this.open();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        this._addBotMessage(this.config.welcomeMessage);
        
        // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ onReady
        setTimeout(() => {
          this.state.isInitialized = true;
          this.config.onReady();
        }, 100);
      }
      
      // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
      _bindEvents() {
        // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è
        this.elements.toggle.addEventListener('click', () => this.open());
        
        // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        this.elements.close.addEventListener('click', () => this.close());
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –∫–ª–∏–∫—É
        this.elements.send.addEventListener('click', () => this._handleSendMessage());
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        this.elements.input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this._handleSendMessage();
          }
        });
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
      _handleSendMessage() {
        const message = this.elements.input.value.trim();
        
        if (!message) return;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        this._addUserMessage(message);
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        this.elements.input.value = '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        this._showTypingIndicator();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        this._sendMessageToServer(message);
      }
      
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      _sendMessageToServer(message) {
        this.state.isLoading = true;
        
        fetch(`${this.config.apiUrl}/api/chat/message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message,
            userId: this.state.userId,
            conversationId: this.state.conversationId,
            language: this.state.language
          })
        })
          .then(response => response.json())
          .then(data => {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
            if (data.success) {
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ä–∞–∑–≥–æ–≤–æ—Ä–∞, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
              if (!this.state.conversationId && data.data.conversationId) {
                this.state.conversationId = data.data.conversationId;
              }
              
              // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
              this._hideTypingIndicator();
              
              // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
              this._addBotMessage(data.data.message);
              
              // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫
              this.config.onMessage(data.data);
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —Å–æ–∑–¥–∞–Ω —Ç–∏–∫–µ—Ç
              if (data.data.ticketCreated && data.data.ticketId) {
                this._showTicketNotification(data.data.ticketId);
                this.config.onTicketCreated(data.data.ticketId);
              }
            } else {
              // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
              this._hideTypingIndicator();
              this._showErrorMessage(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
              this.config.onError(new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
          })
          .catch(error => {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏
            this._hideTypingIndicator();
            this._showErrorMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            this.config.onError(error);
          })
          .finally(() => {
            this.state.isLoading = false;
          });
      }
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      _addUserMessage(text) {
        const timestamp = new Date().toISOString();
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        const messageElement = document.createElement('div');
        messageElement.className = 'shrooms-message shrooms-message-user';
        messageElement.innerHTML = `
          <div class="shrooms-message-content">${this._formatMessage(text)}</div>
          <div class="shrooms-message-time">${this._formatTime(timestamp)}</div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        this.elements.messages.appendChild(messageElement);
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
        this._scrollToBottom();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏–∏
        this.state.messages.push({
          role: 'user',
          content: text,
          timestamp
        });
      }
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
      _addBotMessage(text) {
        const timestamp = new Date().toISOString();
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        const messageElement = document.createElement('div');
        messageElement.className = 'shrooms-message shrooms-message-bot';
        messageElement.innerHTML = `
          <div class="shrooms-message-content">${this._formatMessage(text)}</div>
          <div class="shrooms-message-time">${this._formatTime(timestamp)}</div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        this.elements.messages.appendChild(messageElement);
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
        this._scrollToBottom();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏–∏
        this.state.messages.push({
          role: 'assistant',
          content: text,
          timestamp
        });
      }
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
      _showTypingIndicator() {
        const indicatorElement = document.createElement('div');
        indicatorElement.className = 'shrooms-message shrooms-message-bot';
        indicatorElement.id = 'typing-indicator';
        indicatorElement.innerHTML = `
          <div class="shrooms-typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;
        
        this.elements.messages.appendChild(indicatorElement);
        this._scrollToBottom();
      }
      
      // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
      _hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
          indicator.remove();
        }
      }
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      _showErrorMessage(text) {
        const messageElement = document.createElement('div');
        messageElement.className = 'shrooms-message shrooms-message-bot shrooms-message-error';
        messageElement.style.backgroundColor = '#ff6666';
        messageElement.style.color = '#fff';
        messageElement.innerHTML = `
          <div class="shrooms-message-content">${text}</div>
        `;
        
        this.elements.messages.appendChild(messageElement);
        this._scrollToBottom();
      }
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–∏–∫–µ—Ç–µ
      _showTicketNotification(ticketId) {
        const notificationElement = document.createElement('div');
        notificationElement.className = 'shrooms-ticket-notification';
        notificationElement.innerHTML = `
          <strong>üîî –°–æ–∑–¥–∞–Ω —Ç–∏–∫–µ—Ç #${ticketId}</strong><br>
          –ù–∞—à–∞ –≥—Ä–∏–±–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!
        `;
        
        this.elements.messages.appendChild(notificationElement);
        this._scrollToBottom();
      }
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      _formatMessage(text) {
        // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫–∏ –Ω–∞ <br>
        let formatted = text.replace(/\n/g, '<br>');
        
        // –ó–∞–º–µ–Ω—è–µ–º URL –Ω–∞ —Å—Å—ã–ª–∫–∏
        formatted = formatted.replace(
          /(https?:\/\/[^\s]+)/g, 
          '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
        );
        
        return formatted;
      }
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
      _formatTime(timestamp) {
        const date = new Date(timestamp);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${hours}:${minutes}`;
      }
      
      // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
      _scrollToBottom() {
        const body = document.querySelector('.shrooms-chat-body');
        if (body) {
          body.scrollTop = body.scrollHeight;
        }
      }
      
      // –ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      _getUserId() {
        const storageKey = 'shrooms_widget_user_id';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
        let userId = localStorage.getItem(storageKey);
        
        if (!userId) {
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π ID
          userId = 'user_' + Math.random().toString(36).substr(2, 9);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
          localStorage.setItem(storageKey, userId);
        }
        
        return userId;
      }
      
      // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
      
      // –û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–∂–µ—Ç
      open() {
        if (this.state.isOpen) return;
        
        this.elements.widget.classList.remove('closed');
        this.elements.widget.classList.add('open');
        this.state.isOpen = true;
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        setTimeout(() => {
          this.elements.input.focus();
        }, 300);
        
        // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫
        this.config.onOpen();
      }
      
      // –ó–∞–∫—Ä—ã—Ç—å –≤–∏–¥–∂–µ—Ç
      close() {
        if (!this.state.isOpen) return;
        
        this.elements.widget.classList.remove('open');
        this.elements.widget.classList.add('closed');
        this.state.isOpen = false;
        
        // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫
        this.config.onClose();
      }
      
      // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
      sendMessage(text) {
        if (!text || !this.state.isInitialized) return;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        this._addUserMessage(text);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        this._showTypingIndicator();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        this._sendMessageToServer(text);
      }
      
      // –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
      clearHistory() {
        // –û—á–∏—â–∞–µ–º DOM
        this.elements.messages.innerHTML = '';
        
        // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        this.state.messages = [];
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        this._addBotMessage(this.config.welcomeMessage);
      }
      
      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —è–∑—ã–∫
      setLanguage(language) {
        if (!language || !['en', 'es', 'ru'].includes(language)) return;
        
        this.state.language = language;
      }
      
      // –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      getState() {
        return { ...this.state };
      }
      
      // –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
      getMessages() {
        return [...this.state.messages];
      }
    }
    
    // –ò–Ω—Å—Ç–∞–Ω—Å –≤–∏–¥–∂–µ—Ç–∞
    let widget = null;
    
    // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    function logEvent(event, data = null) {
      const log = document.getElementById('event-log');
      const timestamp = new Date().toLocaleTimeString();
      const message = document.createElement('div');
      
      message.innerHTML = `<strong>${timestamp}</strong>: ${event}`;
      
      if (data) {
        message.innerHTML += ` - ${typeof data === 'object' ? JSON.stringify(data) : data}`;
      }
      
      log.appendChild(message);
      log.scrollTop = log.scrollHeight;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.getElementById('btn-initialize').addEventListener('click', () => {
      if (widget) {
        logEvent('Widget already initialized');
        return;
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞
      widget = new ShroomsDirectWidget({
        apiUrl: 'http://localhost:3000',
        theme: 'neon',
        autoOpen: false,
        welcomeMessage: '–ü—Ä–∏–≤–µ—Ç! –Ø - –≥—Ä–∏–±–Ω–æ–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?',
        onReady: () => logEvent('Widget ready'),
        onMessage: (data) => logEvent('Message received', data.message),
        onOpen: () => logEvent('Widget opened'),
        onClose: () => logEvent('Widget closed'),
        onError: (error) => logEvent('Error', error.message),
        onTicketCreated: (ticketId) => logEvent('Ticket created', ticketId)
      });
      
      logEvent('Widget initialized');
    });
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ
    document.getElementById('btn-open').addEventListener('click', () => {
      if (!widget) {
        logEvent('Widget not initialized');
        return;
      }
      
      widget.open();
      logEvent('Opening widget');
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ
    document.getElementById('btn-close').addEventListener('click', () => {
      if (!widget) {
        logEvent('Widget not initialized');
        return;
      }
      
      widget.close();
      logEvent('Closing widget');
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('btn-send').addEventListener('click', () => {
      if (!widget) {
        logEvent('Widget not initialized');
        return;
      }
      
      const testMessage = '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + new Date().toLocaleTimeString();
      widget.sendMessage(testMessage);
      logEvent('Sending message', testMessage);
    });
    
    // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    document.getElementById('btn-clear').addEventListener('click', () => {
      if (!widget) {
        logEvent('Widget not initialized');
        return;
      }
      
      widget.clearHistory();
      logEvent('Clearing chat history');
    });
    
    // –°–º–µ–Ω–∞ —è–∑—ã–∫–∞
    document.getElementById('language-select').addEventListener('change', (e) => {
      if (!widget) {
        logEvent('Widget not initialized');
        return;
      }
      
      const language = e.target.value;
      widget.setLanguage(language);
      logEvent('Language changed', language);
    });
  </script>
</body>
</html>
