# üçÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å ticketEmailService

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ú—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª–∏ `ticketEmailService` —Å Chat API –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ email –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –¢–µ–ø–µ—Ä—å –±–æ—Ç:

1. **–°–æ–∑–¥–∞–µ—Ç —Ç–∏–∫–µ—Ç** –∫–æ–≥–¥–∞ Claude –∏–ª–∏ `ticketEmailService` –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å
2. **–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç email** —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–≤—è–∑–∏ —Å —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
3. **–û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∏–∫–µ—Ç** —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º email –∞–¥—Ä–µ—Å–æ–º

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### Workflow —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞ —Å email:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –≤–æ–ø—Ä–æ—Å** ‚Üí 
2. **–°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç —Ç–∏–∫–µ—Ç** ‚Üí 
3. **–ë–æ—Ç –ø—Ä–æ—Å–∏—Ç email** ‚Üí 
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç email** ‚Üí 
5. **–¢–∏–∫–µ—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å email** ‚Üí 
6. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ**

## –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### üß™ –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º email

```bash
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Help! My wallet connection is not working",
    "userId": "test-user-email-1",
    "language": "en"
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç–∏–∫–µ—Ç
- –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–º email
- `emailRequested: true` –≤ –æ—Ç–≤–µ—Ç–µ

### üß™ –¢–µ—Å—Ç 2: –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ email

```bash
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email —Ç–µ–º –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "user@example.com",
    "userId": "test-user-email-1",
    "language": "en"
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Email –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ç–∏–∫–µ—Ç—É
- –ë–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ email
- `emailCollected: true` –≤ –æ—Ç–≤–µ—Ç–µ

### üß™ –¢–µ—Å—Ç 3: –†—É—Å—Å–∫–∏–π —è–∑—ã–∫

```bash
# –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞",
    "userId": "test-user-ru",
    "language": "ru"
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ó–∞–ø—Ä–æ—Å email –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

### üß™ –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ pending ticket

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–∏–∫–µ—Ç –≤ –æ–∂–∏–¥–∞–Ω–∏–∏
curl http://localhost:3000/api/chat/users/test-user-email-1/pending-ticket
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "data": {
    "hasPendingTicket": true,
    "ticketId": "TICKET_123",
    "createdAt": "2025-05-27T...",
    "expiresAt": "2025-05-27T...",
    "conversationId": "conv_id"
  }
}
```

### üß™ –¢–µ—Å—Ç 5: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ —Å email

```bash
# –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–±–æ—Ä—É email
curl http://localhost:3000/api/chat/ticket-email-stats
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "data": {
    "pendingTickets": {
      "total": 1,
      "active": 1,
      "expired": 0,
      "timeout": 300
    },
    "timestamp": "2025-05-27T..."
  }
}
```

## –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. Chat API (`server/api/chat.js`)

**–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ pending tickets –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –û–±—Ä–∞–±–æ—Ç–∫–∞ email —Å–æ–æ–±—â–µ–Ω–∏–π
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `ticketEmailService`
- –ù–æ–≤—ã–µ API —ç–Ω–¥–ø–æ–π–Ω—Ç—ã

**–ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–π–Ω—Ç—ã:**
- `GET /api/chat/users/:userId/pending-ticket`
- `GET /api/chat/ticket-email-stats`

### 2. Claude Service (`server/services/claude.js`)

**–£–ø—Ä–æ—â–µ–Ω–∏—è:**
- –£–±—Ä–∞–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –¢–µ–ø–µ—Ä—å –∏—â–µ—Ç —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è Claude –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞
- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ chat.js

### 3. Ticket Email Service (`server/services/ticketEmail.js`)

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `shouldCreateTicket()` - –∞–Ω–∞–ª–∏–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞
- `createPendingTicket()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º email
- `isEmailMessage()` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ email —Å–æ–æ–±—â–µ–Ω–∏–π
- `updateTicketWithEmail()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ —Å email

## –ü—Ä–æ–±–ª–µ–º—ã –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–∏–ª–∏

1. **–ü—Ä–æ–±–ª–µ–º–∞:** Claude –≥–æ–≤–æ—Ä–∏–ª "–æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏" –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤
   **–†–µ—à–µ–Ω–∏–µ:** –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª–∏ `ticketEmailService` –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–∏–∫–µ—Ç—ã –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç email

2. **–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∏–∫–µ—Ç—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–≤—è–∑–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
   **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä email –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∏–∫–µ—Ç–∞

3. **–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤ –±—ã–ª–∞ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ–π –≤ claude.js
   **–†–µ—à–µ–Ω–∏–µ:** –£–ø—Ä–æ—Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–Ω–µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É –≤ chat.js

## –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
```bash
# –§–∏–ª—å—Ç—Ä—É–µ–º –ª–æ–≥–∏ –ø–æ —Ç–∏–∫–µ—Ç–∞–º —Å email
grep "üé´\|email" logs/app.log

# –§–∏–ª—å—Ç—Ä—É–µ–º –ª–æ–≥–∏ –ø–æ ticketEmailService
grep "Pending ticket\|Email collected" logs/app.log
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
```bash
# –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö pending tickets (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
# –ù—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å API —ç–Ω–¥–ø–æ–π–Ω—Ç –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã
curl http://localhost:3000/api/chat/health
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ** —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** –∫–æ–º–∞–Ω–¥–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ –Ω–æ–≤—ã—Ö —Ç–∏–∫–µ—Ç–∞—Ö
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å email —Å–µ—Ä–≤–∏—Å–æ–º** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
4. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–∞–º–∏ —Å email

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ `.env` –µ—Å—Ç—å:
```env
# –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è email (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
EMAIL_TIMEOUT=300000  # 5 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

---

üçÑ **–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** –¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∏–∫–µ—Ç—ã –∏ —Å–æ–±–∏—Ä–∞—Ç—å email –¥–ª—è —Å–≤—è–∑–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.