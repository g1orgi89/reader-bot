# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Email Workflow –≤ Telegram Bot üçÑ

## –û–±–∑–æ—Ä –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

–°–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∞ email –¥–ª—è —Ç–∏–∫–µ—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ Telegram –±–æ—Ç–∞. –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. –°–æ–∑–¥–∞–µ—Ç —Ç–∏–∫–µ—Ç —á–µ—Ä–µ–∑ `ticketEmailService.createPendingTicket()`
2. –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è email (`awaiting_email`)
3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç email –∞–¥—Ä–µ—Å —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ email
5. –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∏–∫–µ—Ç —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º email —á–µ—Ä–µ–∑ `ticketEmailService.updateTicketWithEmail()`
6. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —è–∑—ã–∫–µ

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### üçÑ State Management
- **userStates Map**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **pendingTickets Map**: –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–∫–µ—Ç–∞—Ö –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ email
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞**: –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—á–∏—â–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- **Timeout**: 10 –º–∏–Ω—É—Ç –Ω–∞ –≤–≤–æ–¥ email –∞–¥—Ä–µ—Å–∞

### üçÑ –ö–æ–º–∞–Ω–¥—ã
- **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ**: `/start`, `/help` —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
- **–ù–æ–≤–∞—è**: `/cancel` - –æ—Ç–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∞ email

### üçÑ –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å
- **–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –Ø–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ `ctx.from.language_code`
- **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏**: EN, RU, ES
- **–õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**: –ó–∞–ø—Ä–æ—Å—ã email, –æ—à–∏–±–∫–∏, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

### üçÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- **ticketEmailService**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ–π –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å email
- **conversationService**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞–º–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **messageService**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **claudeService**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º)

```bash
# –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞
cd telegram
node start.js
```

**–¢–µ—Å—Ç 1.1: –û–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "Hello, how are you?"
- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –û–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Claude, —Ç–∏–∫–µ—Ç –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–¢–µ—Å—Ç 1.2: –ö–æ–º–∞–Ω–¥—ã**
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å: `/start`
- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å: `/help`
- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –≠—Ç–∞–ø 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤

**–¢–µ—Å—Ç 2.1: –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (EN)**
```
–û—Ç–ø—Ä–∞–≤–∏—Ç—å: "I have an error with my wallet"
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ
2. ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è pending —Ç–∏–∫–µ—Ç 
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ awaiting_email
4. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å email –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ
```

**–¢–µ—Å—Ç 2.2: –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (RU)**
```
–û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–£ –º–µ–Ω—è –æ—à–∏–±–∫–∞ —Å –∫–æ—à–µ–ª—å–∫–æ–º"
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ
2. ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è pending —Ç–∏–∫–µ—Ç
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ awaiting_email  
4. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å email –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
```

**–¢–µ—Å—Ç 2.3: –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (ES)**
```
–û—Ç–ø—Ä–∞–≤–∏—Ç—å: "Tengo un problema con mi billetera"
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ
2. ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è pending —Ç–∏–∫–µ—Ç
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ awaiting_email
4. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å email –Ω–∞ –∏—Å–ø–∞–Ω—Å–∫–æ–º —è–∑—ã–∫–µ
```

### –≠—Ç–∞–ø 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∞ email

**–¢–µ—Å—Ç 3.1: –í–∞–ª–∏–¥–Ω—ã–π email**
```
–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ: –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç –∏–∑ –¢–µ—Å—Ç–∞ 2.1
–û—Ç–ø—Ä–∞–≤–∏—Ç—å: "user@gmail.com"
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ Email –ø—Ä–∏–∑–Ω–∞–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º
2. ‚úÖ –¢–∏–∫–µ—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å email
3. ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—á–∏—â–∞–µ—Ç—Å—è
4. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —è–∑—ã–∫–µ
```

**–¢–µ—Å—Ç 3.2: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π email**
```
–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ: –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç –∏–∑ –¢–µ—Å—Ç–∞ 2.1
–û—Ç–ø—Ä–∞–≤–∏—Ç—å: "invalid-email"
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ Email –ø—Ä–∏–∑–Ω–∞–µ—Ç—Å—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º
2. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ awaiting_email
4. ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å email
```

**–¢–µ—Å—Ç 3.3: –ö–æ–º–∞–Ω–¥–∞ /cancel**
```
–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ: –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç –∏–∑ –¢–µ—Å—Ç–∞ 2.1
–û—Ç–ø—Ä–∞–≤–∏—Ç—å: "/cancel"
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—á–∏—â–∞–µ—Ç—Å—è
2. ‚úÖ Pending —Ç–∏–∫–µ—Ç —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –ø–∞–º—è—Ç–∏
3. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ
4. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—ã—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ
```

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ timeout –∏ cleanup

**–¢–µ—Å—Ç 4.1: Timeout email –∑–∞–ø—Ä–æ—Å–∞**
```
1. –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 11 –º–∏–Ω—É—Ç (–±–æ–ª—å—à–µ timeout)
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç—Å—è
2. ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ
```

**–¢–µ—Å—Ç 4.2: –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π**
```
1. –°–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–∫–µ—Ç–æ–≤
2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 6 –º–∏–Ω—É—Ç
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –í –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ cleanup
2. ‚úÖ –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–¥–∞–ª—è—é—Ç—Å—è
```

### –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ edge cases

**–¢–µ—Å—Ç 5.1: –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ awaiting_email**
```
–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ: –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç
–û—Ç–ø—Ä–∞–≤–∏—Ç—å: "How are you?" (–≤–º–µ—Å—Ç–æ email)
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π email
2. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ email
```

**–¢–µ—Å—Ç 5.2: –ö–æ–º–∞–Ω–¥—ã –≤ —Ä–µ–∂–∏–º–µ awaiting_email**
```
–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ: –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç
–û—Ç–ø—Ä–∞–≤–∏—Ç—å: "/start"
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ
2. ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ awaiting_email –ù–ï –æ—á–∏—â–∞–µ—Ç—Å—è
3. ‚úÖ –ü–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã —Å–Ω–æ–≤–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è email
```

**–¢–µ—Å—Ç 5.3: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞**
```
–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ: –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç, –Ω–æ –ù–ï –≤–≤–æ–¥–∏—Ç—å email
–û—Ç–ø—Ä–∞–≤–∏—Ç—å: –µ—â–µ –æ–¥–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –°—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
2. ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π pending —Ç–∏–∫–µ—Ç
3. ‚úÖ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è email –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∏–∫–µ—Ç–∞
```

### –≠—Ç–∞–ø 6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ—Å—Ç 6.1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏**
```
1. –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç —á–µ—Ä–µ–∑ Telegram
2. –í–≤–µ—Å—Ç–∏ email
3. –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: http://localhost:3000/client/admin-panel/
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–∫–µ—Ç—ã
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –¢–∏–∫–µ—Ç –≤–∏–¥–µ–Ω –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
2. ‚úÖ Email —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Telegram
```

**–¢–µ—Å—Ç 6.2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**
```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
node diagnose-mongodb.js
```
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. ‚úÖ –¢–∏–∫–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ tickets
2. ‚úÖ Email –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ø–æ–ª–µ email
3. ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç pendingEmail: false, emailCollected: true

## –ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

### –ó–∞–ø—Ä–æ—Å email (RU)
```
üé´ –¢–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ–∑–¥–∞–Ω!

–î–ª—è —Å–≤—è–∑–∏ —Å –Ω–∞—à–∏–º–∏ —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à email –∞–¥—Ä–µ—Å:

–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã
```

### –û—à–∏–±–∫–∞ email (EN)
```
‚ùå Please enter a valid email address (example: user@gmail.com):

Or send /cancel to cancel
```

### –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (ES)
```
‚úÖ ¬°Perfecto! Tu ticket ha sido actualizado con tu email. Nuestros expertos en hongos te contactar√°n dentro de 24 horas. ¬°Tus esporas est√°n en buenas manos! üçÑ
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

```
üçÑ DEBUG: Initiating ticket creation for user 123456789
üçÑ Ticket TKT-20250529-001 created, awaiting email from user 123456789
üçÑ DEBUG: Handling email collection from user 123456789
üçÑ DEBUG: Valid email received: user@example.com
üçÑ Email user@example.com collected for ticket TKT-20250529-001
üçÑ Cleaned up expired email state for user 987654321
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞ —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö:

```javascript
// GET /api/telegram/stats
{
  "userStates": {
    "total": 2,
    "awaitingEmail": 1
  },
  "pendingTickets": {
    "total": 1
  },
  "features": {
    "emailWorkflow": true,
    "stateManagement": true,
    "ticketCreation": true
  }
}
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Email –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB –∏ –ø—Ä–∞–≤–∞ –∑–∞–ø–∏—Å–∏

### –ü—Ä–æ–±–ª–µ–º–∞: –°–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ –æ—á–∏—â–∞—é—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É interval –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ ShroomsTelegramBot

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞ –≤ Telegram –∫–ª–∏–µ–Ω—Ç–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–∏–∫–µ—Ç—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É ticketEmailService.shouldCreateTicket()

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–ó–∞–≤–µ—Ä—à–µ–Ω–æ**: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è email workflow
2. üîÑ **–í –ø—Ä–æ—Ü–µ—Å—Å–µ**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
3. üìã **–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è**: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–∏–∫–µ—Ç–∞–º
4. üìã **–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –æ –Ω–æ–≤—ã—Ö —Ç–∏–∫–µ—Ç–∞—Ö

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∞ email —É—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ Telegram –±–æ—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤—Å–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏. –¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç:

- –ü–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É —á–µ—Ä–µ–∑ —Ç–∏–∫–µ—Ç—ã
- –û–±—â–∞—Ç—å—Å—è —Å –±–æ—Ç–æ–º –Ω–∞ —Ç—Ä–µ—Ö —è–∑—ã–∫–∞—Ö
- –û—Ç–º–µ–Ω—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∞ email
- –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ–±—ã—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç–∏–∫–µ—Ç–æ–≤

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –º–æ–¥—É–ª—å–Ω–æ–π –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ–π –¥–ª—è –±—É–¥—É—â–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π üçÑ