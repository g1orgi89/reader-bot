<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bottom Navigation Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #D2452C;
            padding-bottom: 10px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #D2452C;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-result.pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        button {
            background: #D2452C;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #b53923;
        }
        
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧭 Bottom Navigation Fix Tests</h1>
        
        <div class="test-section">
            <h2>Test 1: Duplicate Navigation Detection</h2>
            <button onclick="testDuplicateNav()">Run Test</button>
            <div id="test1-results"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 2: Class Synchronization (html & body)</h2>
            <button onclick="testClassSync()">Run Test</button>
            <div id="test2-results"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 3: Keyboard Event Simulation</h2>
            <p>Focus and blur the input to test keyboard handling:</p>
            <input type="text" id="test-input" placeholder="Focus me to test keyboard handling">
            <textarea id="test-textarea" placeholder="Or focus me..." rows="3"></textarea>
            <div id="test3-results"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 4: CSS Selector Support</h2>
            <button onclick="testCSSSelectors()">Run Test</button>
            <div id="test4-results"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 5: Viewport Calculator</h2>
            <button onclick="testViewportCalculator()">Run Test</button>
            <div id="test5-results"></div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Bottom Nav Elements</div>
                <div class="stat-value" id="nav-count">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Style Blocks</div>
                <div class="stat-value" id="style-count">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Global Instance</div>
                <div class="stat-value" id="instance-status">-</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Manual Test Controls</h2>
            <button onclick="manualHideNav()">Hide Navigation</button>
            <button onclick="manualShowNav()">Show Navigation</button>
            <button onclick="simulateKeyboardOpen()">Simulate Keyboard Open</button>
            <button onclick="simulateKeyboardClose()">Simulate Keyboard Close</button>
            <button onclick="checkClasses()">Check Classes</button>
        </div>
    </div>
    
    <script>
        // Test Results Helpers
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.textContent = message;
            container.appendChild(result);
        }
        
        function clearResults(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
        }
        
        // Update stats
        function updateStats() {
            const navElements = document.querySelectorAll('.bottom-nav');
            document.getElementById('nav-count').textContent = navElements.length;
            
            const styleBlocks = document.querySelectorAll('#bottom-nav-inline-styles');
            document.getElementById('style-count').textContent = styleBlocks.length;
            
            const hasInstance = window.bottomNavInstance ? '✅' : '❌';
            document.getElementById('instance-status').textContent = hasInstance;
        }
        
        // Test 1: Duplicate Navigation Detection
        function testDuplicateNav() {
            clearResults('test1-results');
            
            const navElements = document.querySelectorAll('.bottom-nav');
            addResult('test1-results', `Found ${navElements.length} .bottom-nav elements`, 'info');
            
            if (navElements.length === 0) {
                addResult('test1-results', '❌ FAIL: No navigation elements found', 'fail');
            } else if (navElements.length === 1) {
                addResult('test1-results', '✅ PASS: Exactly one navigation element exists', 'pass');
            } else {
                addResult('test1-results', `❌ FAIL: ${navElements.length} navigation elements found (expected 1)`, 'fail');
                navElements.forEach((nav, i) => {
                    addResult('test1-results', `  Nav ${i+1}: ${nav.id || 'no-id'} - ${nav.children.length} children`, 'info');
                });
            }
            
            updateStats();
        }
        
        // Test 2: Class Synchronization
        function testClassSync() {
            clearResults('test2-results');
            
            const html = document.documentElement;
            const body = document.body;
            
            // Test adding nav-hidden
            if (window.bottomNavInstance) {
                window.bottomNavInstance.setVisible(false);
                
                const htmlHasClass = html.classList.contains('nav-hidden');
                const bodyHasClass = body.classList.contains('nav-hidden');
                
                addResult('test2-results', `After setVisible(false):`, 'info');
                addResult('test2-results', `  html.nav-hidden: ${htmlHasClass ? '✅' : '❌'}`, htmlHasClass ? 'pass' : 'fail');
                addResult('test2-results', `  body.nav-hidden: ${bodyHasClass ? '✅' : '❌'}`, bodyHasClass ? 'pass' : 'fail');
                
                // Test removing nav-hidden
                window.bottomNavInstance.setVisible(true);
                
                const htmlNoClass = !html.classList.contains('nav-hidden');
                const bodyNoClass = !body.classList.contains('nav-hidden');
                
                addResult('test2-results', `After setVisible(true):`, 'info');
                addResult('test2-results', `  html.nav-hidden removed: ${htmlNoClass ? '✅' : '❌'}`, htmlNoClass ? 'pass' : 'fail');
                addResult('test2-results', `  body.nav-hidden removed: ${bodyNoClass ? '✅' : '❌'}`, bodyNoClass ? 'pass' : 'fail');
                
                if (htmlHasClass && bodyHasClass && htmlNoClass && bodyNoClass) {
                    addResult('test2-results', '✅ PASS: Classes synchronized on both elements', 'pass');
                } else {
                    addResult('test2-results', '❌ FAIL: Class synchronization issue', 'fail');
                }
            } else {
                addResult('test2-results', '❌ FAIL: window.bottomNavInstance not available', 'fail');
            }
        }
        
        // Test 3: Keyboard Events (setup listeners)
        let keyboardOpenFired = false;
        let keyboardCloseFired = false;
        
        window.addEventListener('keyboard:open', () => {
            keyboardOpenFired = true;
            addResult('test3-results', '✅ keyboard:open event fired', 'pass');
            checkKeyboardClasses();
        });
        
        window.addEventListener('keyboard:close', () => {
            keyboardCloseFired = true;
            addResult('test3-results', '✅ keyboard:close event fired', 'pass');
            checkKeyboardClasses();
        });
        
        function checkKeyboardClasses() {
            const html = document.documentElement;
            const body = document.body;
            
            const hasKeyboardOpen = html.classList.contains('keyboard-open') || body.classList.contains('keyboard-open');
            const hasNavHidden = html.classList.contains('nav-hidden') || body.classList.contains('nav-hidden');
            
            addResult('test3-results', `Current classes:`, 'info');
            addResult('test3-results', `  keyboard-open: ${hasKeyboardOpen ? '✅' : '❌'}`, 'info');
            addResult('test3-results', `  nav-hidden: ${hasNavHidden ? '✅' : '❌'}`, 'info');
        }
        
        // Test 4: CSS Selectors
        function testCSSSelectors() {
            clearResults('test4-results');
            
            // Test different selector combinations
            const testSelectors = [
                '.nav-hidden .bottom-nav',
                'html.nav-hidden .bottom-nav',
                'body.nav-hidden .bottom-nav',
                'html.keyboard-open',
                'body.keyboard-open'
            ];
            
            addResult('test4-results', 'Testing CSS selector support:', 'info');
            
            testSelectors.forEach(selector => {
                try {
                    const elements = document.querySelectorAll(selector);
                    // Just verify the selector is valid
                    addResult('test4-results', `  "${selector}": ✅ Valid`, 'pass');
                } catch (e) {
                    addResult('test4-results', `  "${selector}": ❌ Invalid`, 'fail');
                }
            });
            
            // Test that our combined selectors work
            const html = document.documentElement;
            html.classList.add('nav-hidden');
            
            const navHidden = document.querySelector('html.nav-hidden .bottom-nav');
            if (navHidden) {
                addResult('test4-results', '✅ PASS: Combined selector works', 'pass');
            } else {
                addResult('test4-results', '❌ FAIL: Combined selector not working', 'fail');
            }
            
            html.classList.remove('nav-hidden');
        }
        
        // Test 5: Viewport Calculator
        function testViewportCalculator() {
            clearResults('test5-results');
            
            if (window.viewportCalculator) {
                const sizes = window.viewportCalculator.measureRealElementSizes();
                addResult('test5-results', '✅ Viewport calculator found', 'pass');
                addResult('test5-results', `  Header height: ${sizes.headerHeight}px`, 'info');
                addResult('test5-results', `  Bottom nav height: ${sizes.bottomNavHeight}px`, 'info');
                
                if (sizes.bottomNavHeight > 0) {
                    addResult('test5-results', '✅ PASS: Navigation height measured correctly', 'pass');
                } else {
                    addResult('test5-results', '⚠️ WARNING: Navigation height is 0', 'fail');
                }
            } else {
                addResult('test5-results', '❌ FAIL: window.viewportCalculator not available', 'fail');
            }
        }
        
        // Manual Controls
        function manualHideNav() {
            if (window.bottomNavInstance) {
                window.bottomNavInstance.setVisible(false);
                console.log('Navigation hidden manually');
                checkClasses();
            }
        }
        
        function manualShowNav() {
            if (window.bottomNavInstance) {
                window.bottomNavInstance.setVisible(true);
                console.log('Navigation shown manually');
                checkClasses();
            }
        }
        
        function simulateKeyboardOpen() {
            const html = document.documentElement;
            const body = document.body;
            html.classList.add('nav-hidden', 'keyboard-open');
            body.classList.add('nav-hidden', 'keyboard-open');
            window.dispatchEvent(new Event('keyboard:open'));
            console.log('Simulated keyboard open');
            checkClasses();
        }
        
        function simulateKeyboardClose() {
            const html = document.documentElement;
            const body = document.body;
            html.classList.remove('nav-hidden', 'keyboard-open');
            body.classList.remove('nav-hidden', 'keyboard-open');
            window.dispatchEvent(new Event('keyboard:close'));
            console.log('Simulated keyboard close');
            checkClasses();
        }
        
        function checkClasses() {
            const html = document.documentElement;
            const body = document.body;
            console.log('Current classes:', {
                html: {
                    navHidden: html.classList.contains('nav-hidden'),
                    keyboardOpen: html.classList.contains('keyboard-open')
                },
                body: {
                    navHidden: body.classList.contains('nav-hidden'),
                    keyboardOpen: body.classList.contains('keyboard-open')
                }
            });
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            updateStats();
            
            // Run initial tests after a delay
            setTimeout(() => {
                console.log('Running initial tests...');
                testDuplicateNav();
            }, 1000);
        });
        
        // Listen for keyboard events
        document.getElementById('test-input').addEventListener('focus', () => {
            clearResults('test3-results');
            addResult('test3-results', 'Input focused - waiting for keyboard handlers...', 'info');
        });
        
        document.getElementById('test-input').addEventListener('blur', () => {
            addResult('test3-results', 'Input blurred - waiting for keyboard handlers...', 'info');
        });
    </script>
</body>
</html>
