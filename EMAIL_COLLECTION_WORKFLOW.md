# Email Collection Workflow Implementation

## üéØ –¶–µ–ª—å

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–≥–æ UX –¥–ª—è —Å–±–æ—Ä–∞ email –∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏.

## üìã –°—Ü–µ–Ω–∞—Ä–∏–π —Ä–∞–±–æ—Ç—ã

```
üë§ "–£ –º–µ–Ω—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—à–µ–ª–µ–∫" 
ü§ñ "üé´ I've created a support ticket for you! To help our mushroom experts reach you, please share your email address:"
üë§ "user@gmail.com"
ü§ñ "‚úÖ Perfect! Your ticket has been updated with your email. Our mushroom experts will contact you within 24 hours. Your spores are in good hands! üçÑ"
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **TicketEmailService** (`server/services/ticketEmail.js`)
   - –£–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏–∫–æ–π —Å–±–æ—Ä–∞ email
   - –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ "–Ω–µ–ø–æ–ª–Ω—ã—Ö" —Ç–∏–∫–µ—Ç–æ–≤
   - –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - –í–∞–ª–∏–¥–∞—Ü–∏—è email –∞–¥—Ä–µ—Å–æ–≤

2. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π main server** (`server/index.js`)
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è workflow –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —Ä–µ–∂–∏–º–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–∂–∏–¥–∞—é—â–∏—Ö —Ç–∏–∫–µ—Ç–æ–≤

3. **–¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** (`test-email-workflow.html`)
   - –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π UI –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è workflow
   - –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
   - –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:

**–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ø—Ä–æ–±–ª–µ–º:**
- **English:** error, bug, problem, issue, not work, broken, failed, stuck, can't, wallet, transaction
- **–†—É—Å—Å–∫–∏–π:** –æ—à–∏–±–∫–∞, –±–∞–≥, –ø—Ä–æ–±–ª–µ–º–∞, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–ª–æ–º–∞–Ω–æ, –Ω–µ –º–æ–≥—É, –∫–æ—à–µ–ª–µ–∫, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è  
- **Espa√±ol:** error, problema, fallo, roto, no funciona, billetera, transacci√≥n

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã:**
- –ù–∞–ª–∏—á–∏–µ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
- –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è > 50 —Å–∏–º–≤–æ–ª–æ–≤
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### Workflow States

1. **IDLE** - –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
2. **AWAITING_EMAIL** - –¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω, –æ–∂–∏–¥–∞–µ—Ç—Å—è email (5 –º–∏–Ω—É—Ç)
3. **EMAIL_COLLECTED** - Email –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
4. **EMAIL_ERROR** - –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ email

### Memory Management

- **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:** `Map<userId, PendingTicket>`
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:** –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
- **Timeout:** 5 –º–∏–Ω—É—Ç –Ω–∞ –≤–≤–æ–¥ email
- **Graceful shutdown:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã

–û—Ç–∫—Ä—ã—Ç—å: `http://localhost:3000/test-email-workflow.html`

**–ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- `üá∑üá∫ Test Problem` - –¢–µ—Å—Ç –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- `üá∫üá∏ Test Problem` - –¢–µ—Å—Ç –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º  
- `üìß Test Email RU/EN` - –¢–µ—Å—Ç –≤–≤–æ–¥–∞ email
- `‚ùå Invalid Email` - –¢–µ—Å—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ email
- `üîÑ Full Workflow` - –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –†—É—á–Ω—ã–µ —Ç–µ—Å—Ç—ã

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ —Å email:**
   ```
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è"
   –ë–æ—Ç: "üé´ I've created a support ticket for you! ..."
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "test@gmail.com"  
   –ë–æ—Ç: "‚úÖ Perfect! Your ticket has been updated..."
   ```

2. **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π email:**
   ```
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π"
   –ë–æ—Ç: "üé´ I've created a support ticket..."
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "not-an-email"
   –ë–æ—Ç: "Please enter a valid email address..."
   ```

3. **–¢–∞–π–º–∞—É—Ç email:**
   ```
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–û—à–∏–±–∫–∞ –≤ –∫–æ—à–µ–ª—å–∫–µ"
   –ë–æ—Ç: "üé´ I've created a support ticket..."
   [–ñ–¥–µ–º 5+ –º–∏–Ω—É—Ç]
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "user@test.com"
   –ë–æ—Ç: "Ticket request expired. Please create a new support request."
   ```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health Check

```bash
curl http://localhost:3000/api/health
```

**–ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –æ—Ç–≤–µ—Ç–µ:**
```json
{
  "services": {
    "ticketEmail": "ok"
  },
  "ticketEmailService": {
    "total": 0,
    "active": 0, 
    "expired": 0,
    "timeout": 300
  }
}
```

### –ú–µ—Ç—Ä–∏–∫–∏

```bash
curl http://localhost:3000/api/metrics
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
```json
{
  "pendingTickets": {
    "total": 2,
    "active": 1,
    "expired": 1,
    "timeout": 300
  }
}
```

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è

```javascript
// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞
logger.info(`üé´ Ticket created and email requested: ${ticketId}`);

// –°–±–æ—Ä email  
logger.info(`‚úÖ Email collected for ticket: ${ticketId} - ${email}`);

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö
logger.info(`üßπ Cleaned up ${count} expired pending tickets`);

// Shutdown —Å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º–∏ —Ç–∏–∫–µ—Ç–∞–º–∏
logger.warn(`‚ö†Ô∏è Shutting down with ${active} pending tickets awaiting email`);
```

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –£—Å–ø–µ—à–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ ‚Üí –ó–∞–ø—Ä–æ—Å email ‚Üí –í–≤–æ–¥ email ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –í—Ä–µ–º—è —Å–±–æ—Ä–∞ email: < 2 –º–∏–Ω—É—Ç (95% —Å–ª—É—á–∞–µ–≤)

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏  
- –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π email: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å
- –¢–∞–π–º–∞—É—Ç: —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–∫–µ—Ç–∞
- –û—Ç–∫–∞–∑ –æ—Ç email: –æ–±—ã—á–Ω—ã–π –¥–∏–∞–ª–æ–≥ –±–µ–∑ —Ç–∏–∫–µ—Ç–∞

## üöÄ Deployment

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ MongoDB –∏ Claude API.

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–∫–µ—Ç—ã –±–µ–∑ email –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å–µ —Ç–∏–∫–µ—Ç—ã
- ‚úÖ API endpoints –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –°—Ç–∞—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

## üîÑ –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

### Planned Features

1. **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ email
2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±–æ—Ä–∞** - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∞ email  
3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤** - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ —Ç–∏–∫–µ—Ç–æ–≤ –≤ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **Smart detection** - ML-–º–æ–¥–µ–ª—å –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
2. **Multiple channels** - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram, WhatsApp –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. **Ticket priority** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
4. **User profiles** - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ email –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π

## üêõ Known Issues

1. **Memory leaks prevention** - –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—á–∏—â–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
2. **Race conditions** - –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∏–∫–µ—Ç
3. **Email validation** - –ü—Ä–æ—Å—Ç–∞—è regex –≤–∞–ª–∏–¥–∞—Ü–∏—è (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)

## üìù Changelog

### v1.0.0 (2025-05-27)
- ‚úÖ –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è email collection workflow
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (EN, RU, ES)