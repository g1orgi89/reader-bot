# üçÑ PROMPT CONFLICTS RESOLUTION REPORT

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–æ–º–ø—Ç—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä–æ–º–ø—Ç–æ–≤ (`prompts-fixed.js`) –∏ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π (`PromptService`).

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ –≠–¢–ê–ü 1: –£–ë–ò–†–ê–ï–ú –ö–û–ù–§–õ–ò–ö–¢–´ (–ë–ï–ó–û–ü–ê–°–ù–û)

#### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `server/services/diagnostics.js`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª —É—Å—Ç–∞—Ä–µ–≤—à–∏–π `prompts-fixed.js`
```javascript
// –ë–´–õ–û:
const { DIAGNOSTIC_QUESTIONS, QUICK_SOLUTIONS } = require('../config/prompts-fixed');

// –°–¢–ê–õ–û:
// Inline –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞ (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ —Ñ–∞–π–ª–∞

#### 2. –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω `server/config/prompts-fixed.js`
**–ü—Ä–æ–±–ª–µ–º–∞:** –§–∞–π–ª —Å–æ–∑–¥–∞–≤–∞–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å `PromptService`
```javascript
// –°–¢–ê–õ–û:
throw new Error(`üçÑ –û–®–ò–ë–ö–ê: prompts-fixed.js –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!`);
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–º–ø–æ—Ä—Ç–æ–≤

#### 3. –°–æ–∑–¥–∞–Ω backup `server/config/prompts-fixed-backup.js`
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏

### ‚úÖ –≠–¢–ê–ü 2: –ü–†–û–í–ï–†–ö–ê CLAUDE.JS

**–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞ `server/services/claude.js`:**
- ‚úÖ –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –û–¢–°–£–¢–°–¢–í–£–Æ–¢
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `PromptService` 
- ‚úÖ –ï—Å—Ç—å fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–æ–π

```javascript
// –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø:
async _getSystemPrompt(language = 'en') {
  try {
    return await promptService.getActivePrompt('basic', language);
  } catch (error) {
    return promptService.getDefaultPrompt('basic', language);
  }
}
```

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### üü¢ –†–ê–ë–û–¢–ê–ï–¢:
1. **PromptService** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –∏–∑ MongoDB
2. **Fallback —Å–∏—Å—Ç–µ–º–∞** - —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –∏–∑ `fallbackPrompts.js`
3. **DiagnosticsService** - inline –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
4. **Claude.js** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PromptService

### üü° –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´ –ù–ï–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø RAG:

1. **–ü—Ä–æ–±–ª–µ–º—ã —Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–æ–π:**
   - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ Qdrant
   - –í—ã—Å–æ–∫–∏–π –ø–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (0.7)
   - –ü—Ä–æ–±–ª–µ–º—ã —Å embeddings

2. **–ü—Ä–æ–±–ª–µ–º—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:**
   - `ENABLE_RAG=false` –≤ .env
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Qdrant

3. **–ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ –≤ –ë–î:**
   - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –≤ MongoDB
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ fallback –ø—Ä–æ–º–ø—Ç—ã

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ RAG:
```bash
# –í .env —Ñ–∞–π–ª–µ:
ENABLE_RAG=true
VECTOR_DB_URL=http://localhost:6333
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã:
```javascript
// –ß–µ—Ä–µ–∑ API /api/admin/knowledge/diagnose
// –ò–ª–∏ —á–µ—Ä–µ–∑ vectorStoreService.healthCheck()
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã –≤ MongoDB:
```javascript
// –ß–µ—Ä–µ–∑ API /api/admin/prompts
// –ò–ª–∏ —á–µ—Ä–µ–∑ promptService.diagnose()
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä–æ–≥–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏:
```javascript
// –í claude.js _getRelevantContext():
const score_threshold = 0.7; // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–Ω–∏–∑–∏—Ç—å –¥–æ 0.4
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É** –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫ RAG
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
4. **–î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –±–∞–∑—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
- ‚úÖ `server/services/diagnostics.js` - —É–±—Ä–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç prompts-fixed.js
- ‚úÖ `server/config/prompts-fixed.js` - –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω  
- ‚úÖ `server/config/prompts-fixed-backup.js` - —Å–æ–∑–¥–∞–Ω backup

## –§–∞–π–ª—ã –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ):
- ‚úÖ `server/services/claude.js` - —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ `server/services/promptService.js` - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ `server/config/fallbackPrompts.js` - —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –≥–æ—Ç–æ–≤—ã